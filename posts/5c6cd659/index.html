<!-- build time:Sat Jun 06 2020 10:04:23 GMT+0800 (中国标准时间) --><!DOCTYPE html><html class="theme-next pisces use-motion" lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic|Fira Code:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><meta name="keywords" content="springcloud,微服务,"><link rel="alternate" href="/atom.xml" title="pxBlog" type="application/atom+xml"><meta name="description" content="参考视频：阳哥带你学spring cloud代码地址：https://github.com/PhoenixXC/LearnJava/tree/master/SpringCloud/ShangGuiGu准备版本对应关系浏览器访问：https://start.spring.io/actuator/info可以获得版本的详细对应关系视频版本推荐组件版本cloudHoxton.SR1boot2.2.2.R"><meta name="keywords" content="springcloud,微服务"><meta property="og:type" content="article"><meta property="og:title" content="SpringCloud学习"><meta property="og:url" content="https://phoenixxc.github.io/posts/5c6cd659/index.html"><meta property="og:site_name" content="pxBlog"><meta property="og:description" content="参考视频：阳哥带你学spring cloud代码地址：https://github.com/PhoenixXC/LearnJava/tree/master/SpringCloud/ShangGuiGu准备版本对应关系浏览器访问：https://start.spring.io/actuator/info可以获得版本的详细对应关系视频版本推荐组件版本cloudHoxton.SR1boot2.2.2.R"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200428101353.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200428103817.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200501152323.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200501152546.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200501152709.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200503182951.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200503183041.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200504102930.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200504104253.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200504104403.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200603185418.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200603185448.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200603185459.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200603185509.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200515094751515.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200603185518.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200603185525.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200515152956331.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200515155510923.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200515163840134.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200515163939132.png"><meta property="og:image" content="https://phoenixxc.github.io/%25E6%25A1%258C%25E9%259D%25A2/SpringCloud/image-20200515164145277.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200515164118122.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200515164215423.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200515170200727.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200515171249066.png"><meta property="og:image" content="https://phoenixxc.github.io/%25E6%25A1%258C%25E9%259D%25A2/SpringCloud/image-20200516101744716.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200516101811035.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200516102122254.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200516102413660.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200516102444142.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200516102613937.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200516102658309.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200516102745956.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200516102851959.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200516103449631.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200516103538800.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200516103620470.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200516115113746.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200516150541277.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200516150737648.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200516152508447.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200516160221957.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200516160250739.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200516160520534.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200516160531750.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200516160555219.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200516200826226.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200516202814953.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200517173045025.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200517201055956.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200605161303.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200605161241.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200605161229.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200605161103.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200605161023.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200605160938.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200605160918.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200605160852.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200605160841.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200605160903.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200605160823.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200605160224.png"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2019/jpeg/338441/1561258986171-4ddec33c-a632-4ec3-bfff-7ef4ffc33fb9.jpeg"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200605160107.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200605160022.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200605160010.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200605155957.png"><meta property="og:image" content="https://phoenixxc.github.io/%25E6%25A1%258C%25E9%259D%25A2/SpringCloud/image-20200523181903368.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200605155942.png"><meta property="og:image" content="https://phoenixxc.github.io/%25E6%25A1%258C%25E9%259D%25A2/SpringCloud/image-20200524175848893.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200605155918.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200525100417.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200525100438.png"><meta property="og:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200525102501.png"><meta property="og:image" content="http://seata.io/img/architecture.png"><meta property="og:updated_time" content="2020-06-05T09:25:29.857Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="SpringCloud学习"><meta name="twitter:description" content="参考视频：阳哥带你学spring cloud代码地址：https://github.com/PhoenixXC/LearnJava/tree/master/SpringCloud/ShangGuiGu准备版本对应关系浏览器访问：https://start.spring.io/actuator/info可以获得版本的详细对应关系视频版本推荐组件版本cloudHoxton.SR1boot2.2.2.R"><meta name="twitter:image" content="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200428101353.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Pisces",version:"5.1.4",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!1,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="https://phoenixxc.github.io/posts/5c6cd659/"><title>SpringCloud学习 | pxBlog</title><script>!function(e,t,a,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=t.createElement(a),s=t.getElementsByTagName(a)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-133199137-1","auto"),ga("send","pageview")</script><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?287228c85e03519cfe0be7c0c9433846";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">pxBlog</span> <span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle"></p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i> </span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://phoenixxc.github.io/posts/5c6cd659/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="PhoenixBM"><meta itemprop="description" content><meta itemprop="image" content="/images/avatar.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="pxBlog"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">SpringCloud学习</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-06-05T17:19:00+08:00">2020-06-05 </time></span><span class="post-comments-count"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-comment-o"></i> </span><a href="/posts/5c6cd659/#comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/posts/5c6cd659/" itemprop="commentCount"></span> </a></span><span id="/posts/5c6cd659/" class="leancloud_visitors" data-flag-title="SpringCloud学习"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="post-meta-item-text">阅读次数&#58;</span> <span class="leancloud-visitors-count"></span></span></div></header><div class="post-body" itemprop="articleBody"><blockquote><p>参考视频：<a href="https://www.bilibili.com/video/av93824064?p=148&amp;t=553" target="_blank" rel="noopener">阳哥带你学spring cloud</a></p><p>代码地址：<a href="https://github.com/PhoenixXC/LearnJava/tree/master/SpringCloud/ShangGuiGu" target="_blank" rel="noopener">https://github.com/PhoenixXC/LearnJava/tree/master/SpringCloud/ShangGuiGu</a></p></blockquote><h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><h4 id="版本对应关系"><a href="#版本对应关系" class="headerlink" title="版本对应关系"></a>版本对应关系</h4><p>浏览器访问：<a href="https://start.spring.io/actuator/info" target="_blank" rel="noopener">https://start.spring.io/actuator/info</a></p><p>可以获得版本的详细对应关系</p><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200428101353.png" alt></p><p><strong>视频版本推荐</strong></p><table><thead><tr><th>组件</th><th>版本</th></tr></thead><tbody><tr><td><strong><em>cloud</em></strong></td><td>Hoxton.SR1</td></tr><tr><td><strong><em>boot</em></strong></td><td>2.2.2.RELEASE</td></tr><tr><td><strong><em>cloud alibaba</em></strong></td><td>2.1.0.RELEASE</td></tr><tr><td><strong><em>Java</em></strong></td><td>Java 8</td></tr><tr><td><strong><em>Maven</em></strong></td><td>3.5+</td></tr><tr><td><strong><em>MySQL</em></strong></td><td>5.7+</td></tr></tbody></table><h4 id="Cloud-停更"><a href="#Cloud-停更" class="headerlink" title="Cloud 停更"></a>Cloud 停更</h4><ul><li>被动修复 bugs</li><li>不接受合并请求</li><li>不再发布新版本</li></ul><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200428103817.png" alt></p><h4 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h4><p>查看官网文档/社区中文版。</p><h2 id="架构搭建"><a href="#架构搭建" class="headerlink" title="架构搭建"></a>架构搭建</h2><ul><li><u>约定 &gt; 配置 &gt; 编码</u></li></ul><h4 id="微服务模块的创建"><a href="#微服务模块的创建" class="headerlink" title="微服务模块的创建"></a>微服务模块的创建</h4><ol><li>建立 <em>module</em></li><li>修改 <em>pom</em></li><li>编写 <em>YML</em></li><li>主启动</li><li>业务类</li></ol><h4 id="热部署的开启"><a href="#热部署的开启" class="headerlink" title="热部署的开启"></a>热部署的开启</h4><blockquote><p>热部署在开发阶段中使用，不要在生产环境中使用</p></blockquote><ol><li><p>项目中添加 <strong><em>devtools</em></strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- pom.xml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>在 <em>pom.xml</em> 中添加插件</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- pom.xml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>cloud-provider-payment8001<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 热部署 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">fork</span>&gt;</span>true<span class="tag">&lt;/<span class="name">fork</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">addResources</span>&gt;</span>true<span class="tag">&lt;/<span class="name">addResources</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>启用 <strong><em>automatic build</em></strong></p><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200501152323.png" alt></p></li><li><p>更新值</p><ul><li><p>Idea 中 <kbd>CTRL+SHIFT+ALT+/</kbd> ：</p><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200501152546.png" alt></p></li><li><p>点击 <kbd>Registry</kbd></p></li><li><p>将框住的选项打钩</p><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200501152709.png" alt></p></li></ul></li><li><p>重启 IDEA</p></li></ol><h2 id="服务治理"><a href="#服务治理" class="headerlink" title="服务治理"></a>服务治理</h2><p><strong>服务治理</strong>：</p><p>管理服务之间的依赖关系，可以实现服务调用，负载均衡、容错等，实现服发现和注册</p><h3 id="Eureka"><a href="#Eureka" class="headerlink" title="Eureka"></a>Eureka</h3><h4 id="集群原理"><a href="#集群原理" class="headerlink" title="集群原理"></a>集群原理</h4><ul><li><p><strong><em>Eureka Server</em></strong></p><ul><li><p>服务注册</p><p>将服务信息注册进注册中心</p></li><li><p>服务发现</p><p>从注册中心上获取服务信息，实质：存 <code>key</code> 服务名，取 <code>value</code> 调用地址</p></li></ul></li><li><p><strong><em>Service Provider</em></strong></p><ol><li>先启动 <em>eureka</em> 注册中心</li><li>启动服务提供者</li><li>服务提供者将自身的信息注册进 eureka</li></ol></li><li><p><strong><em>Service Consumer</em></strong></p><ol><li>消费者在需要调用接口时，使用服务别名去注册中心获取实际的 RPC 远程调用地址</li><li>消费者获取调用地址后，底层利用 <code>HttpClient</code> 技术实现远程调用</li><li>消费者获取服务地址后会缓存在本地 Jvm 内存中，默认每隔 30 秒更新一次服务调用地址</li></ol></li></ul><h4 id="自我保护机制"><a href="#自我保护机制" class="headerlink" title="自我保护机制"></a>自我保护机制</h4><p><strong>原因</strong>：</p><ul><li>某时刻某一个微服务不可用了，Eureka 不会立刻清理，依旧会保留微服务信息</li><li>CAP 理论中的 AP 分支</li></ul><p><strong>如何关闭</strong>：</p><ul><li><code>yml</code> 中设置 <code>eureka.server.eable-self-preservation=false</code></li></ul><h3 id="Zookeeper"><a href="#Zookeeper" class="headerlink" title="Zookeeper"></a>Zookeeper</h3><ul><li><p>引入 zookeeper-discovery</p></li><li><p>排除自带的 zookeeper，引入版本合适的 zookeeper</p></li><li><p>yml文件配置</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line">    <span class="comment"># 微服务注册名称</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">cloud-payment-service</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    zookeeper:</span></span><br><span class="line"><span class="attr">      connect-string:</span> <span class="number">169.22</span><span class="number">.2</span><span class="number">.2</span><span class="string">:2181</span></span><br></pre></td></tr></table></figure></li><li><p>SpringBoot 启动类加上注解：<code>@EnableDiscoveryClient</code></p></li></ul><p>启动服务后，在 /services 下面会有有服务名称相同的节点，里面有一个临时节点存储了服务注册的信息。</p><blockquote><p>Zookeeper 没有自我保护机制</p></blockquote><h3 id="Consul"><a href="#Consul" class="headerlink" title="Consul"></a>Consul</h3><p>Go 语言编写</p><h4 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h4><ul><li>服务注册</li><li>健康检查</li><li>KV存储</li><li>安全</li><li>多数据</li></ul><h3 id="三个注册中心异同"><a href="#三个注册中心异同" class="headerlink" title="三个注册中心异同"></a>三个注册中心异同</h3><table><thead><tr><th>组件</th><th>语言</th><th>CAP</th><th>服务健康检查</th><th>对外暴露端口</th><th>SpringCloud集成</th></tr></thead><tbody><tr><td>Eureka</td><td>Java</td><td>AP</td><td>可配</td><td>HTTP</td><td>集成</td></tr><tr><td>Consul</td><td>Go</td><td>CP</td><td>支持</td><td>HTTP/DNS</td><td>集成</td></tr><tr><td>Zookeeper</td><td>Java</td><td>CP</td><td>支持</td><td>客户端</td><td>集成</td></tr></tbody></table><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200503182951.png" alt></p><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200503183041.png" alt></p><h2 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h2><h3 id="关于"><a href="#关于" class="headerlink" title="关于"></a>关于</h3><h4 id="什么是负载均衡"><a href="#什么是负载均衡" class="headerlink" title="什么是负载均衡"></a>什么是负载均衡</h4><p>将用户的请求平摊的分配到多个服务上，从而达到系统的 HA （高可用）。</p><p>常见的负载均衡有软件 Nginx，LVS，硬件 F5 等</p><h4 id="本地负载均衡客户端-vs-Nginx-服务端负载均衡"><a href="#本地负载均衡客户端-vs-Nginx-服务端负载均衡" class="headerlink" title="本地负载均衡客户端 vs Nginx 服务端负载均衡"></a>本地负载均衡客户端 vs Nginx 服务端负载均衡</h4><p>Nginx 是服务器负载均衡，客户端说起有请求都会交给 Nginx，然后由 Nginx 实现请求转发。</p><p>Ribbon 本地负载均衡，在调用微服务接口的时候，会在注册中心上获取注册信息服务列表之后缓存到 JVM 本地，从而在本地实现 RPC 远程服务调用技术。</p><h4 id="集中式-vs-进程内"><a href="#集中式-vs-进程内" class="headerlink" title="集中式 vs 进程内"></a>集中式 vs 进程内</h4><ul><li><p>集中式</p><p>在服务的消费方和提供方之间使用独立的 LB 设施，由该设施负责把访问请求通过某种策略转发至服务的提供方。</p></li><li><p>进程内</p><p>将 LB 集成到消费方</p></li></ul><h3 id="Ribbon"><a href="#Ribbon" class="headerlink" title="Ribbon"></a>Ribbon</h3><p>Ribbon 是一个软负债均衡的客户端组件，可以和其他客户端配合使用。</p><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200504102930.png" alt></p><p>工作分为两步：</p><ol><li>先选择 EurekaServer，优先选择在同一个区域内负债较少的 server</li><li>根据用户指定的策略，在从 server 取到的服务注册列表中选择一个地址。</li></ol><blockquote><p>Ribbon 提供了多种策略，轮训、随机和根据响应时间加权等</p></blockquote><blockquote><p>引入 Eureka 的时候，默认引入了 Ribbon</p></blockquote><h4 id="IRule"><a href="#IRule" class="headerlink" title="IRule"></a>IRule</h4><p>Ribbon 内置了很多负载均衡策略：</p><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200504104253.png" alt></p><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200504104403.png" alt></p><h4 id="替换负载均衡算法"><a href="#替换负载均衡算法" class="headerlink" title="替换负载均衡算法"></a>替换负载均衡算法</h4><ol><li><p>创建自定义配置</p><blockquote><p>自定义配置类不能放在 <code>@CompoentScan</code> 所扫描的包以及子包下，否则这个自定义的配置类就会被所有的 Ribbon 客户端共享，达不到特殊化定制的目的。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MySelfRule</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IRule <span class="title">myRule</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RandomRule();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>主启动类添加 <code>@RibbonClient</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@RibbonClient</span>(name = <span class="string">"CLOUD-PAYMENT-SERVICE"</span>, configuration = MySelfRule.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderMain80</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(OrderMain80.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h4 id="负载均衡算法原理"><a href="#负载均衡算法原理" class="headerlink" title="负载均衡算法原理"></a>负载均衡算法原理</h4><ul><li><p>轮训</p><p>rest 接口第几次请求数 % 服务器集群总数量 = 实际调用服务器位置下标，每次服务重启后 rest 从1开始计数</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> AtomicInteger nextServerCyclicCounter;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> AVAILABLE_ONLY_SERVERS = <span class="keyword">true</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> ALL_SERVERS = <span class="keyword">false</span>;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Logger log = LoggerFactory.getLogger(RoundRobinRule.class);</span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">RoundRobinRule</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    nextServerCyclicCounter = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">RoundRobinRule</span><span class="params">(ILoadBalancer lb)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>();</span><br><span class="line">    setLoadBalancer(lb);</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">public</span> Server <span class="title">choose</span><span class="params">(ILoadBalancer lb, Object key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (lb == <span class="keyword">null</span>) &#123;</span><br><span class="line">        log.warn(<span class="string">"no load balancer"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    Server server = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (server == <span class="keyword">null</span> &amp;&amp; count++ &lt; <span class="number">10</span>) &#123;</span><br><span class="line">        List&lt;Server&gt; reachableServers = lb.getReachableServers();</span><br><span class="line">        List&lt;Server&gt; allServers = lb.getAllServers();</span><br><span class="line">        <span class="keyword">int</span> upCount = reachableServers.size();</span><br><span class="line">        <span class="keyword">int</span> serverCount = allServers.size();</span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> ((upCount == <span class="number">0</span>) || (serverCount == <span class="number">0</span>)) &#123;</span><br><span class="line">            log.warn(<span class="string">"No up servers available from load balancer: "</span> + lb);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">  </span><br><span class="line">        <span class="keyword">int</span> nextServerIndex = incrementAndGetModulo(serverCount);</span><br><span class="line">        server = allServers.get(nextServerIndex);</span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (server == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">/* Transient. */</span></span><br><span class="line">            Thread.yield();</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (server.isAlive() &amp;&amp; (server.isReadyToServe())) &#123;</span><br><span class="line">            <span class="keyword">return</span> (server);</span><br><span class="line">        &#125;</span><br><span class="line">  </span><br><span class="line">        <span class="comment">// Next.</span></span><br><span class="line">        server = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (count &gt;= <span class="number">10</span>) &#123;</span><br><span class="line">        log.warn(<span class="string">"No available alive servers after 10 tries from load balancer: "</span></span><br><span class="line">                + lb);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> server;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Inspired by the implementation of &#123;<span class="doctag">@link</span> AtomicInteger#incrementAndGet()&#125;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> modulo The modulo to bound the value of the counter.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> The next value.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">incrementAndGetModulo</span><span class="params">(<span class="keyword">int</span> modulo)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">int</span> current = nextServerCyclicCounter.get();</span><br><span class="line">        <span class="keyword">int</span> next = (current + <span class="number">1</span>) % modulo;</span><br><span class="line">        <span class="keyword">if</span> (nextServerCyclicCounter.compareAndSet(current, next))</span><br><span class="line">            <span class="keyword">return</span> next;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Server <span class="title">choose</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> choose(getLoadBalancer(), key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h4 id="手写负载均衡算法"><a href="#手写负载均衡算法" class="headerlink" title="手写负载均衡算法"></a>手写负载均衡算法</h4><p>原理 + <strong><em>JUC</em></strong>(CAS + 自旋锁)</p><h2 id="服务调用"><a href="#服务调用" class="headerlink" title="服务调用"></a>服务调用</h2><h3 id="OpenFegin"><a href="#OpenFegin" class="headerlink" title="OpenFegin"></a>OpenFegin</h3><p>Fegin 是一个声明式的 WebService 客户端，使用 Fegin 可以让客户端更加简单。</p><p>使用方法：定义一个服务接口然后在上面添加注解，支持可拔插式的编码器和解码器。</p><p>SpringCloud 对 Fegin 进行了封装，使其支持 Spring MVC 标准注解和 HttpMessgaeConverts。Fegin 可以与 Eureka 和 Ribbon 组合使用以支持负载均衡</p><hr><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200603185418.png" alt></p><h4 id="超时设置"><a href="#超时设置" class="headerlink" title="超时设置"></a>超时设置</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    config:</span></span><br><span class="line"><span class="attr">      default:</span></span><br><span class="line">        <span class="comment"># 建立链接后从服务器读取到可用资源所用的时间</span></span><br><span class="line"><span class="attr">        connectTimeout:</span> <span class="number">5000</span></span><br><span class="line">        <span class="comment"># 两端建立连接所用的时间</span></span><br><span class="line"><span class="attr">        readTimeout:</span> <span class="number">5000</span></span><br><span class="line">        <span class="comment"># 设置日志类型，打印</span></span><br><span class="line"><span class="attr">        loggerLevel:</span> <span class="string">full</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line"><span class="attr">  level:</span></span><br><span class="line">    <span class="string">com.example.springcloud.service.PaymentFeignService:</span> <span class="string">debug</span></span><br></pre></td></tr></table></figure><blockquote><p><a href="https://cloud.spring.io/spring-cloud-static/spring-cloud-openfeign/3.0.0.M1/reference/html/#configuration-properties" target="_blank" rel="noopener">https://cloud.spring.io/spring-cloud-static/spring-cloud-openfeign/3.0.0.M1/reference/html/#configuration-properties</a></p></blockquote><h4 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h4><p>官网文档有，yml 中配置 config 或创建一个 config bean</p><h2 id="服务降级"><a href="#服务降级" class="headerlink" title="服务降级"></a>服务降级</h2><blockquote><ul><li><p><strong><em>Hystrix</em></strong></p><p>目前停更，但是用处很多，非常重要</p></li><li><p>resillience4j</p><p>国外用的多</p></li><li><p><strong>sentinel</strong></p><p>ali牛掰</p></li></ul></blockquote><p>复制分布式系统结构中的应用有数十个依赖关系，每个依赖关系在某些时候将不可避免的失败</p><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200603185448.png" alt></p><h4 id="服务雪崩"><a href="#服务雪崩" class="headerlink" title="服务雪崩"></a>服务雪崩</h4><p>多个微服务之间调用的时候，假设微服务A调用微服务B和微服务C，微服务B和微服务C又调用其他的微服务，这就是所谓的“扇出”。</p><p>如果扇出的链路上某个微服务的调用响应时间过长或不可用，对微服务A的调用就会占用越来越多的系统资源，进而引起系统崩溃，导致“<strong>雪崩效应</strong>”。</p><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200603185459.png" alt></p><h4 id="服务降级（fallback）"><a href="#服务降级（fallback）" class="headerlink" title="服务降级（fallback）"></a>服务降级（fallback）</h4><p><strong>导致服务降级的原因</strong>：</p><ul><li><p>程序运行异常</p></li><li><p>超时</p></li><li><p>服务熔断触发服务降级</p></li><li><p>线程池/信号量打满也会导致服务降级</p></li></ul><h4 id="服务熔断（break）"><a href="#服务熔断（break）" class="headerlink" title="服务熔断（break）"></a>服务熔断（break）</h4><p>达到最大服务访问后，直接决绝访问，调用服务降级的方法返回友好提示。</p><h4 id="服务限流（flowlimit）"><a href="#服务限流（flowlimit）" class="headerlink" title="服务限流（flowlimit）"></a>服务限流（flowlimit）</h4><p>秒杀高并发等操作，严禁一起来，先排队，一秒n个，有序进行</p><h3 id="Hystrix"><a href="#Hystrix" class="headerlink" title="Hystrix"></a>Hystrix</h3><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200603185509.png" alt></p><h4 id="做用"><a href="#做用" class="headerlink" title="做用"></a>做用</h4><ul><li><p>服务降级</p></li><li><p>服务熔断</p></li><li><p>接近实时监控</p></li></ul><h4 id="服务降级-Pratice"><a href="#服务降级-Pratice" class="headerlink" title="服务降级 Pratice"></a>服务降级 Pratice</h4><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200515094751515.png" alt="image-20200515094751515"></p><p>使用注解 <code>@HystrixCommand</code></p><ul><li><p>8001</p><p>设置自身调用时间的峰值，峰值内可以正常运行</p><p>超过了需要有兜底的方法处理，作服务降级 fallback</p></li></ul><p><strong>服务端</strong>：</p><p>主启动类上添加：<code>@EnableCircuitBreaker</code></p><p>服务上添加</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@HystrixCommand</span>(fallbackMethod = <span class="string">"paymentInfoTimeoutHandler"</span>, commandProperties = &#123;</span><br><span class="line">        <span class="comment">// 设置线程的超时时间为3秒</span></span><br><span class="line">        <span class="meta">@HystrixProperty</span>(name = <span class="string">"execution.isolation.thread.timeoutInMilliseconds"</span>, value = <span class="string">"3000"</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">paymentInfoTimeout</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> timeNumber = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// int age = 10 / 0;</span></span><br><span class="line">        TimeUnit.SECONDS.sleep(timeNumber);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"线程池："</span> + Thread.currentThread().getName() + <span class="string">" paymentInfoTimeout"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">paymentInfoTimeoutHandler</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"线程池："</span> + Thread.currentThread().getName() + <span class="string">" paymentInfoTimeoutHandler, :("</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>不管是运行超时还是服务异常，都会使用 fallback</p><p>服务降级既可以加在客户端，也可以加载服务端，<strong>一般加载客户端</strong></p><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200603185518.png" alt></p><p><strong>客户端</strong>：</p><p>主启动类加上注解：<code>@EnableHystrix</code></p><p>服务上：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@HystrixCommand</span>(fallbackMethod = <span class="string">"paymentInfoTimeoutFallbackMethod"</span>, commandProperties = &#123;</span><br><span class="line">        <span class="comment">// 设置线程的超时时间为3秒</span></span><br><span class="line">        <span class="meta">@HystrixProperty</span>(name = <span class="string">"execution.isolation.thread.timeoutInMilliseconds"</span>, value = <span class="string">"1500"</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/order/payment/hystrix/timeout/&#123;id&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">paymentInfoTimeout</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> Integer id) </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> age = <span class="number">10</span> / <span class="number">0</span>;</span><br><span class="line">    String result = paymentHystrixService.paymentInfoTimeout(id);</span><br><span class="line">    log.info(<span class="string">"--- result: "</span> + result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">paymentInfoTimeoutFallbackMethod</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> Integer id) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"Sorry, I'm consumer80, service busy, please wait some time try again"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><p><strong>存在的问题</strong>：</p><ul><li>Fallback 代码与业务代码耦合</li><li>代码膨胀</li></ul><p><strong>解决方式</strong>：</p><p>大部分用通用 Fallback，类上配置注解：<code>@DefaultProperties(defaultFallback = &quot;paymentTimeoutFallbackMethod&quot;)</code></p><p>需要降级的方法上直接 <code>@HystrixCommand</code></p><p>通用 Fallback 的返回值要兼容，<strong>且不能有参数</strong></p><p>同时为了处理代码耦合，由于需要降级处理的都是来自 OpenFeign 的那个接口，所以可以让 Feign 开启 Hyxtrix，实现该接口，并在接口注解上指定实现类作为 fallback</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@FeignClient</span>(value = <span class="string">"CLOUD-PROVIDER-HYSTRIX-PAYMENT"</span>, fallback = PaymentFallbackService.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PaymentHystrixService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/payment/hystrix/ok/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function">String <span class="title">paymentInfoOk</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> Integer id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/payment/hystrix/timeout/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function">String <span class="title">paymentInfoTimeout</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> Integer id)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentFallbackService</span> <span class="keyword">implements</span> <span class="title">PaymentHystrixService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">paymentInfoOk</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"--- PaymentFallbackService OK, :("</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">paymentInfoTimeout</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"--- PaymentFallbackService Timeout, :("</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># feign 开启 hystrix</span></span><br><span class="line"><span class="attr">feign:</span></span><br><span class="line"><span class="attr">  hystrix:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>这样当失败时，会调用指定的接口实现类中对应的方法，而且不会处理htstrixCommand指定的的fallback。</p><h4 id="服务熔断"><a href="#服务熔断" class="headerlink" title="服务熔断"></a>服务熔断</h4><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200603185525.png" alt></p><p>三种状态：</p><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200515152956331.png" alt="image-20200515152956331"></p><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200515155510923.png" alt="image-20200515155510923"></p><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200515163840134.png" alt="image-20200515163840134"></p><p><strong>断路器起作用的条件</strong>：</p><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200515163939132.png" alt="image-20200515163939132"></p><p>如果断路器开启：</p><p><img src="../../../%25E6%25A1%258C%25E9%259D%25A2/SpringCloud/image-20200515164145277.png" alt="image-20200515164145277"></p><p>进入半开启：</p><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200515164118122.png" alt="image-20200515164118122"></p><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200515164215423.png" alt="image-20200515164215423"></p><h4 id="Hystrix-Dashboard"><a href="#Hystrix-Dashboard" class="headerlink" title="Hystrix Dashboard"></a>Hystrix Dashboard</h4><ul><li><p>都要添加 actutor 依赖</p></li><li><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200515170200727.png" alt="image-20200515170200727"></p></li><li><p>被监控服务注入一个bean</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 配置服务器监控默认路径</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="meta">@Bean</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> ServletRegistrationBean <span class="title">getServlet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     HystrixMetricsStreamServlet streamServlet = <span class="keyword">new</span> HystrixMetricsStreamServlet();</span><br><span class="line">     ServletRegistrationBean registrationBean = <span class="keyword">new</span> ServletRegistrationBean(streamServlet);</span><br><span class="line">     registrationBean.setLoadOnStartup(<span class="number">1</span>);</span><br><span class="line">     registrationBean.addUrlMappings(<span class="string">"/hystrix.stream"</span>);</span><br><span class="line">     registrationBean.setName(<span class="string">"HystrixMetricsStreamServlet"</span>);</span><br><span class="line">     <span class="keyword">return</span> registrationBean;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></li><li><p>打开监控页面，输入服务url:hystrix.stream</p></li></ul><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200515171249066.png" alt="image-20200515171249066"></p><h2 id="服务网关"><a href="#服务网关" class="headerlink" title="服务网关"></a>服务网关</h2><p>zuul 停更，计划 zuul2，3名作者被挖走，大佬撕逼，导致 zuul2 夭折，Spring 社区受不了自己弄了 <em>gateway</em>。</p><h3 id="Gateway"><a href="#Gateway" class="headerlink" title="Gateway"></a>Gateway</h3><p><img src="../../../%25E6%25A1%258C%25E9%259D%25A2/SpringCloud/image-20200516101744716.png" alt="image-20200516101744716"></p><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200516101811035.png" alt="image-20200516101811035"></p><h4 id="作用-1"><a href="#作用-1" class="headerlink" title="作用"></a>作用</h4><ul><li>反向代理</li><li>鉴权</li><li>流量控制</li><li>熔断</li><li>日志监控</li></ul><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200516102122254.png" alt="image-20200516102122254"></p><h4 id="优势"><a href="#优势" class="headerlink" title="优势"></a>优势</h4><p>Neflix 一直跳票，Gateway 由 SpringCloud 研发，集成度更好。</p><p>Gateway 基于异步非阻塞模型开发，性能优秀。</p><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200516102413660.png" alt="image-20200516102413660"></p><hr><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200516102444142.png" alt="image-20200516102444142"></p><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200516102613937.png" alt="image-20200516102613937"></p><h4 id="Zuul-模型"><a href="#Zuul-模型" class="headerlink" title="Zuul 模型"></a>Zuul 模型</h4><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200516102658309.png" alt="image-20200516102658309"></p><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200516102745956.png" alt="image-20200516102745956"></p><h4 id="Gateway-1"><a href="#Gateway-1" class="headerlink" title="Gateway"></a>Gateway</h4><p>使用了 WebFlux ：</p><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200516102851959.png" alt="image-20200516102851959"></p><h4 id="路由-Route"><a href="#路由-Route" class="headerlink" title="路由(Route)"></a>路由(Route)</h4><p>是构建网关的基本模块，由 ID、目标 URI、一系列的断言和过滤器组成，如果断言为 true 则匹配该路由。</p><h4 id="断言-Predicate"><a href="#断言-Predicate" class="headerlink" title="断言(Predicate)"></a>断言(Predicate)</h4><p>参考 Java8 的 <em>java.util.function.Predicate</em></p><p>开发人员可以匹配 HTTP 请求中的所有内容（如请求参数和请求头），如果请求与断言相匹配则进行路由</p><h4 id="过滤-Filter"><a href="#过滤-Filter" class="headerlink" title="过滤(Filter)"></a>过滤(Filter)</h4><p>指的是 Spring 框架中 <em>GateFilter</em> 的实例，使用过滤器，可以在请求被路由前或路由后进行修改。</p><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200516103449631.png" alt="image-20200516103449631"></p><h4 id="Gateway-工作流程"><a href="#Gateway-工作流程" class="headerlink" title="Gateway 工作流程"></a>Gateway 工作流程</h4><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200516103538800.png" alt="image-20200516103538800"></p><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200516103620470.png" alt="image-20200516103620470"><strong>核心逻辑</strong>：路由转发 ＋执行过滤器链</p><h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><ul><li><p>导入 Gateway</p></li><li><p>移除 starter-web 这个包，如果需要 web 支持，可以导入 starter-webflux</p></li><li><p>配置（静态）</p><ul><li><p><em>yaml</em></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">cloud-gateway</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">        - id:</span> <span class="string">payment_routh</span>  <span class="comment"># 路由ID，要求唯一，建议配合服务名</span></span><br><span class="line"><span class="attr">          uri:</span> <span class="attr">http://localhost:8001</span> <span class="comment"># 匹配后提供的路由地址</span></span><br><span class="line"><span class="attr">          predicates:</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">Path=/payment/get/**</span>   <span class="comment"># 断言</span></span><br><span class="line"></span><br><span class="line"><span class="attr">        - id:</span>  <span class="string">payment_routh</span>  <span class="comment"># 路由ID，要求唯一，建议配合服务名</span></span><br><span class="line"><span class="attr">          uri:</span> <span class="attr">http://localhost:8001</span> <span class="comment"># 匹配后提供的路由地址</span></span><br><span class="line"><span class="attr">          predicates:</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">Path=/payment/lb/**</span></span><br></pre></td></tr></table></figure></li><li><p>创建Bean</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RouteLocator <span class="title">customRouteLocator</span><span class="params">(RouteLocatorBuilder routeLocatorBuilder)</span> </span>&#123;</span><br><span class="line">    RouteLocatorBuilder.Builder routes = routeLocatorBuilder.routes();</span><br><span class="line"></span><br><span class="line">    routes.route(<span class="string">"path_route_xcphoenix"</span>,</span><br><span class="line">                 r -&gt; r.path(<span class="string">"/guonei"</span>)</span><br><span class="line">                 .uri(<span class="string">"https://news.baidu.com/"</span>));</span><br><span class="line">    <span class="keyword">return</span> routes.build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul></li><li><p>配置（动态）</p><blockquote><p>静态路由会写死 url，但是多数情况下是要部署集群的，这就需要通过微服务名实现动态路由</p></blockquote><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200516115113746.png" alt="image-20200516115113746"></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">cloud-gateway</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      discovery:</span></span><br><span class="line"><span class="attr">        locator:</span></span><br><span class="line">          <span class="comment"># 开启从注册中心动态创建路由的功能，利用微服务名进行路由</span></span><br><span class="line"><span class="attr">          enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">        - id:</span> <span class="string">payment_routh</span>  <span class="comment"># 路由ID，要求唯一，建议配合服务名</span></span><br><span class="line"><span class="comment">#          uri: http://localhost:8001 # 匹配后提供的路由地址</span></span><br><span class="line"><span class="attr">          uri:</span> <span class="attr">lb://CLOUD-PAYMENT-SERVICE</span> <span class="comment"># 匹配后提供微服务的路由地址</span></span><br><span class="line"><span class="attr">          predicates:</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">Path=/payment/get/**</span>   <span class="comment"># 断言</span></span><br><span class="line">          </span><br><span class="line"><span class="attr">        - id:</span>  <span class="string">payment_routh2</span>  <span class="comment"># 路由ID，要求唯一，建议配合服务名</span></span><br><span class="line"><span class="comment">#          uri: http://localhost:8001 # 匹配后提供的路由地址</span></span><br><span class="line"><span class="attr">          uri:</span> <span class="attr">lb://CLOUD-PAYMENT-SERVICE</span></span><br><span class="line"><span class="attr">          predicates:</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">Path=/payment/lb/**</span>   <span class="comment"># 断言</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="Predicate"><a href="#Predicate" class="headerlink" title="Predicate"></a>Predicate</h4><p>官方提供了很多 Predicate：</p><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200516150541277.png" alt="image-20200516150541277"></p><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200516150737648.png" alt="image-20200516150737648"></p><h4 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h4><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200516152508447.png" alt="image-20200516152508447"></p><p>自定义：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyLogGatewayFilter</span> <span class="keyword">implements</span> <span class="title">GlobalFilter</span>, <span class="title">Ordered</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"---------- come in myLogGatewayFilter"</span>);</span><br><span class="line">        String uname = exchange.getRequest().getQueryParams().getFirst(<span class="string">"uname"</span>);</span><br><span class="line">        <span class="keyword">if</span> (uname == <span class="keyword">null</span>) &#123;</span><br><span class="line">            log.info(<span class="string">"----- 非法用户"</span>);</span><br><span class="line">            exchange.getResponse().setStatusCode(HttpStatus.NOT_ACCEPTABLE);</span><br><span class="line">            <span class="keyword">return</span> exchange.getResponse().setComplete();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 优先级，值越小优先级越高</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="服务配置"><a href="#服务配置" class="headerlink" title="服务配置"></a>服务配置</h2><h3 id="Config"><a href="#Config" class="headerlink" title="Config"></a>Config</h3><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200516160221957.png" alt="image-20200516160221957"></p><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200516160250739.png" alt="image-20200516160250739"></p><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200516160520534.png" alt="image-20200516160520534"></p><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200516160531750.png" alt="image-20200516160531750"></p><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200516160555219.png" alt="image-20200516160555219"></p><p>The HTTP service has resources in the following form:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/&#123;application&#125;/&#123;profile&#125;[/&#123;label&#125;]</span><br><span class="line">/&#123;application&#125;-&#123;profile&#125;.yml</span><br><span class="line">/&#123;label&#125;/&#123;application&#125;-&#123;profile&#125;.yml</span><br><span class="line">/&#123;application&#125;-&#123;profile&#125;.properties</span><br><span class="line">/&#123;label&#125;/&#123;application&#125;-&#123;profile&#125;.properties</span><br></pre></td></tr></table></figure><p>where <code>application</code> is injected as the <code>spring.config.name</code> in the <code>SpringApplication</code> (what is normally <code>application</code> in a regular Spring Boot app), <code>profile</code> is an active profile (or comma-separated list of properties), and <code>label</code> is an optional git label (defaults to <code>master</code>.)</p><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200516200826226.png" alt="image-20200516200826226"></p><blockquote><p>不管是 <code>.yml</code> 还是 <code>.properties</code> 都可以通过 <u>xxxx.yml</u> 或 <u>xxxx.properties</u>。</p><p>其中 <code>/{application}/{profile}[/{label}]</code> 这种格式返回的是一个 <code>json</code> 字符串</p><p>其他四种返回的都是对应的文件内容</p><blockquote><p>如果访问一个不存在的配置，那么返回一个表示错误的 <code>json</code> 字符串</p></blockquote></blockquote><h4 id="服务端配置"><a href="#服务端配置" class="headerlink" title="服务端配置"></a>服务端配置</h4><ul><li><p><strong><em>maven</em></strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Config --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-config-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p><strong><em>yml</em></strong></p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">cloud-config-center</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    config:</span></span><br><span class="line"><span class="attr">      server:</span></span><br><span class="line"><span class="attr">        git:</span></span><br><span class="line"><span class="attr">          uri:</span> <span class="string">/home/xuanc/桌面/LearnJava/SpringCloud/ShangGuiGu/springcloud-config</span></span><br><span class="line"><span class="attr">      label:</span> <span class="string">master</span></span><br></pre></td></tr></table></figure><p>可以使用 git 或者文件路径，git 可以需要配置用户名和密码，git 地址，仓库名等</p></li></ul><h4 id="客户端配置"><a href="#客户端配置" class="headerlink" title="客户端配置"></a>客户端配置</h4><ul><li><p><strong><em>maven</em></strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 写错就是一个坑 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Config --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>配置 <code>bootstrap.yml</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">3355</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">config-client</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    config:</span></span><br><span class="line"><span class="attr">      label:</span> <span class="string">master</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">config</span></span><br><span class="line"><span class="attr">      profile:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">      uri:</span> <span class="attr">http://config3344:3344</span></span><br><span class="line">      </span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    server-url:</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://eureka7001:7001/eureka</span></span><br></pre></td></tr></table></figure></li><li><p>code</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;config.info&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String configInfo;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/configInfo"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getConfigInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> configInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><code>config.info</code> 来自 <em>config</em>-<em>server</em> 中配置的信息（git或文件中的数据），客户端通过配置向服务端发送请求，获取到：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; &#123;"name":"config","profiles":["dev"],"label":"master","version":"e7b77b33bada2e2812236072305022642242c58b","state":null,"propertySources":[&#123;"name":"/home/xuanc/桌面/LearnJava/SpringCloud/ShangGuiGu/springcloud-config/config-dev.yml","source":&#123;"config.info":"master branch,springcloud-config/config-dev.yml version=1"&#125;&#125;]&#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></blockquote><blockquote><p>并取出其中的 propertySources 与添加到客户端的环境属性中，这样客户端可以直接通过 <code>config.info</code> 去访问配置信息</p></blockquote></li></ul><h4 id="boostrap-yml"><a href="#boostrap-yml" class="headerlink" title="boostrap.yml"></a>boostrap.yml</h4><p><code>application.yml</code> 是用户级</p><p><code>bootstrap.yml</code> 是系统级的，优先级更高</p><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200516202814953.png" alt="image-20200516202814953"></p><h4 id="配置刷新"><a href="#配置刷新" class="headerlink" title="配置刷新"></a>配置刷新</h4><p>当文件发生变化后（git 需要 commit 才行），服务端可以感知到变化并更新配置，客户端不能立马感知。</p><p><strong>设置动态刷新</strong>：</p><ol><li><p>引入 <code>actuator</code> 模块</p></li><li><p>暴露监控端点</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">management:</span></span><br><span class="line"><span class="attr">  endpoints:</span></span><br><span class="line"><span class="attr">    web:</span></span><br><span class="line"><span class="attr">      exposure:</span></span><br><span class="line"><span class="attr">        include:</span> <span class="string">"*"</span></span><br></pre></td></tr></table></figure></li><li><p>控制类加上 <code>@RefreshScope</code></p></li><li><p>发送 POST 刷新 <code>http://localhost:3355/actuator/refresh</code></p></li></ol><blockquote><p>缺点：</p><ul><li>不能广播，批量刷新，同时保证精确刷新</li></ul></blockquote><h2 id="消息总线"><a href="#消息总线" class="headerlink" title="消息总线"></a>消息总线</h2><h3 id="Bus"><a href="#Bus" class="headerlink" title="Bus"></a>Bus</h3><p>为了解决上面的动态刷新的问题，引入了 SpringCloud Bus</p><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200517173045025.png" alt="image-20200517173045025"></p><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/image-20200517201055956.png" alt="image-20200517201055956"></p><p>第二种架构更加合适，第一种：</p><ul><li>破坏了微服务的职责单一性，微服务本身是业务模块，不应该承担配置刷新的职责</li><li>破坏了微服务各节点的对等性</li><li>有一定的局限性，比如当微服务迁移时，网络地址和常常会发生变化</li></ul><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200605161303.png" alt></p><p>Bus 支持两种 MQ：RabbitMQ、Kafka</p><h4 id="Config自动刷新步骤"><a href="#Config自动刷新步骤" class="headerlink" title="Config自动刷新步骤"></a>Config自动刷新步骤</h4><blockquote><p>基于上面的手动刷新</p></blockquote><ol><li><p>添加依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Bus: RabbitMQ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bus-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>需要amqp以及actuator依赖</p></li><li><p>yaml 配置 RabbitMQ</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置rabbitmq</span></span><br><span class="line"><span class="attr">rabbitmq:</span></span><br><span class="line"><span class="attr">  host:</span> <span class="string">localhost</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">5672</span></span><br><span class="line"><span class="attr">  username:</span> <span class="string">guest</span></span><br><span class="line"><span class="attr">  password:</span> <span class="string">guest</span></span><br></pre></td></tr></table></figure></li></ol><hr><p>前两部分服务端和客户端都要配置</p><ol start="3"><li><p>服务端暴露端点</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># rabbitmq相关配置，暴露bus刷新配置的端点</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line"><span class="attr">  endpoints:</span></span><br><span class="line"><span class="attr">    web:</span></span><br><span class="line"><span class="attr">      exposure:</span></span><br><span class="line"><span class="attr">        include:</span> <span class="string">'*'</span></span><br></pre></td></tr></table></figure></li><li><p><kbd>POST</kbd> 请求：<code>http://ip:port/actuator/bus-refresh</code></p><p>这样就可以自动刷新客户端的配置（控制器要有 <code>@RefreshScope</code>）</p></li></ol><h4 id="定点通知"><a href="#定点通知" class="headerlink" title="定点通知"></a>定点通知</h4><p>在上面配置完成后，如果需要定点刷新，可以发送 POST <code>/actuator/bus-refresh/{destination}</code></p><p>服务端收到请求后，会通过参数来指定需要更新配置的服务或实例</p><h2 id="Cloud-Stream"><a href="#Cloud-Stream" class="headerlink" title="Cloud Stream"></a>Cloud Stream</h2><blockquote><p>常用的 MQ（消息中间件）</p><ul><li><em>ActiveMQ</em></li><li><em>RabbitMQ</em></li><li><em>RocketMQ</em></li><li><em>Kafka</em></li></ul><hr><p>MQ 太多，如果服务用到多个 MQ，那么切换、维护、开发都会带来困难</p><p>所以需要一种适配绑定的方式，自动的在各种 MQ 切换</p><p>那么 <strong><em>springcloud stream</em></strong> 就可以屏蔽 MQ 的细节</p></blockquote><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><h4 id="是什么"><a href="#是什么" class="headerlink" title="是什么"></a>是什么</h4><p>屏蔽底层消息中间件的差异，降低切换成本，统一消息的编程模型。</p><p>Spring Cloud Stream 是一个构建消息驱动微服务的框架。</p><p>应用程序通过 inputs 和 outputs 来与 Spring Cloud Stream 中 binder 对象交互</p><p>所以，只需要搞清楚如何与 Spring Cloud Stream 交互就可以方便使用消息驱动的方式。</p><p>通过使用 Spring Integration 来连接消息代理中间件以实现消息事件驱动。</p><p>Spring Cloud Stream 为一些供应商的消息中间件产品提供了个性化的自动化配置实现，引发了发布-订阅、消费组、分区的三个核心概念。</p><p>目前仅支持：RabbitMQ、Kafka</p><blockquote><p>Binder 绑定器是屏蔽 MQ 的核心</p></blockquote><h3 id="设计思想"><a href="#设计思想" class="headerlink" title="设计思想"></a>设计思想</h3><h4 id="标准MQ"><a href="#标准MQ" class="headerlink" title="标准MQ"></a>标准MQ</h4><p>生产者/消费者之间靠消息媒介传递消息内容：<strong><em>Message</em></strong></p><p>消息必须走特定的通道：<strong><em>消息通道MessageChannel</em></strong></p><p>消息通道里的消息如何被消费，谁负责收发消息：<strong><em>消息通道的子接口 SubscribableChannel，由 MessageHandler 消息处理器所订阅</em></strong></p><h4 id="为什么用Cloud-Stream"><a href="#为什么用Cloud-Stream" class="headerlink" title="为什么用Cloud Stream"></a>为什么用Cloud Stream</h4><p>如果用到了多个 MQ，多个 MQ 的架构不同，直接使用会导致代码耦合，切换和适配就十分困难。</p><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200605161241.png" alt></p><p>通过定义绑定器 Binder 作为中间层，实现了应用程序和消息中间件细节之间的隔离</p><h4 id="Binder"><a href="#Binder" class="headerlink" title="Binder"></a>Binder</h4><ul><li><p>INPUT</p><p>消费者</p></li><li><p>OUTPUT</p><p>生产者</p></li></ul><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200605161229.png" alt></p><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200605161103.png" alt></p><h4 id="通信方式"><a href="#通信方式" class="headerlink" title="通信方式"></a>通信方式</h4><p>发布——订阅模式，使用 Topic 主题广播（RabbitMQ -&gt; Exchange，Kafka -&gt; Topic）</p><h3 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h3><h4 id="组成"><a href="#组成" class="headerlink" title="组成"></a>组成</h4><ul><li><p>Binder</p><p>连接中间件，屏蔽差异</p></li><li><p>Channel</p><p>通道，是队列 Queue 的一种抽象，在消息通讯系统中就是实现存储和转发的媒介，通过 Channel 对队列进行配置</p></li><li><p>可以理解为参照对象是 Spring Cloud Stream 自身，从 Stream 发布消息就是输出，接受消息就是输入</p></li></ul><h4 id="常用注解"><a href="#常用注解" class="headerlink" title="常用注解"></a>常用注解</h4><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200605161023.png" alt></p><h4 id="USE"><a href="#USE" class="headerlink" title="USE"></a>USE</h4><ol><li><p>导入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- MQ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-stream-rabbit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>Yaml 配置</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">cloud-stream-provider</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    stream:</span></span><br><span class="line">      <span class="comment"># 配置需要绑定的 rabbitmq 的服务信息</span></span><br><span class="line"><span class="attr">      binders:</span></span><br><span class="line">        <span class="comment"># 表示定义的名称，用于 binding 整合</span></span><br><span class="line"><span class="attr">        defaultRabbit:</span></span><br><span class="line">          <span class="comment"># 消息组件类型</span></span><br><span class="line"><span class="attr">          type:</span> <span class="string">rabbit</span></span><br><span class="line">          <span class="comment"># mq 环境配置</span></span><br><span class="line"><span class="attr">          enviroment:</span></span><br><span class="line"><span class="attr">            spring:</span></span><br><span class="line"><span class="attr">              rabbitmq:</span></span><br><span class="line"><span class="attr">                host:</span> <span class="string">localhost</span></span><br><span class="line"><span class="attr">                port:</span> <span class="number">5672</span></span><br><span class="line"><span class="attr">                username:</span> <span class="string">guest</span></span><br><span class="line"><span class="attr">                password:</span> <span class="string">guest</span></span><br><span class="line">      <span class="comment"># 服务资源整合</span></span><br><span class="line"><span class="attr">      bindings:</span></span><br><span class="line">        <span class="comment"># 通道名，消费端为input</span></span><br><span class="line"><span class="attr">        output:</span></span><br><span class="line">          <span class="comment"># 要使用的 Exchange 名称</span></span><br><span class="line"><span class="attr">          destination:</span> <span class="string">studyExchange</span></span><br><span class="line">          <span class="comment"># 消息类型</span></span><br><span class="line"><span class="attr">          content-type:</span> <span class="string">application/json</span></span><br><span class="line">          <span class="comment"># 设置绑定的消息服务的具体设置</span></span><br><span class="line"><span class="attr">          binder:</span> <span class="string">defaultRabbit</span></span><br></pre></td></tr></table></figure></li><li><p>生产者</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义消息的推送管道</span></span><br><span class="line"><span class="meta">@EnableBinding</span>(Source.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageProviderImpl</span> <span class="keyword">implements</span> <span class="title">IMessageProvider</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 消息发送管道</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> MessageChannel output;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">send</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String serial = UUID.randomUUID().toString();</span><br><span class="line">        <span class="comment">// 发送</span></span><br><span class="line">        output.send(MessageBuilder.withPayload(serial)</span><br><span class="line">                .build());</span><br><span class="line">        log.info(<span class="string">"----&gt; serial: "</span> + serial);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>消费者</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@EnableBinding</span>(Sink.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReceiveMessageController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;server.port&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String serverPort;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@StreamListener</span>(Sink.INPUT)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">input</span><span class="params">(Message&lt;String&gt; message)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"receive: "</span> + message.getPayload() + <span class="string">"\t port: "</span> + serverPort);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>泛型和生产者类型要匹配</p></blockquote></li></ol><h4 id="分组消费和持久化"><a href="#分组消费和持久化" class="headerlink" title="分组消费和持久化"></a>分组消费和持久化</h4><p><strong>重复消费</strong></p><p>如果有多个消费端，会出现消息被重复消费的问题；</p><p>这种就需要用到 <strong>消息分组</strong> 才解决，在 Stream 中，处于同一个 group 的多个消费者是竞争关系，能够保证消息只会被其中一个应用消费一次。</p><p>==不同组是可以重复消费的，同一个组存在竞争关系。==</p><blockquote><p>不配置的话，默认情况下 group 是不同的</p></blockquote><p>设置分组的方法：</p><ul><li><p>修改 yaml 配置</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">cloud-stream-consumer</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    stream:</span></span><br><span class="line">      <span class="comment"># 配置需要绑定的 rabbitmq 的服务信息</span></span><br><span class="line"><span class="attr">      binders:</span></span><br><span class="line">        <span class="comment"># 表示定义的名称，用于 binding 整合</span></span><br><span class="line"><span class="attr">        defaultRabbit:</span></span><br><span class="line">          <span class="comment"># 消息组件类型</span></span><br><span class="line"><span class="attr">          type:</span> <span class="string">rabbit</span></span><br><span class="line">          <span class="comment"># mq 环境配置</span></span><br><span class="line"><span class="attr">          enviroment:</span></span><br><span class="line"><span class="attr">            spring:</span></span><br><span class="line"><span class="attr">              rabbitmq:</span></span><br><span class="line"><span class="attr">                host:</span> <span class="string">localhost</span></span><br><span class="line"><span class="attr">                port:</span> <span class="number">5672</span></span><br><span class="line"><span class="attr">                username:</span> <span class="string">guest</span></span><br><span class="line"><span class="attr">                password:</span> <span class="string">guest</span></span><br><span class="line">      <span class="comment"># 服务资源整合</span></span><br><span class="line"><span class="attr">      bindings:</span></span><br><span class="line">        <span class="comment"># 通道名</span></span><br><span class="line"><span class="attr">        input:</span></span><br><span class="line">          <span class="comment"># 要使用的 Exchange 名称</span></span><br><span class="line"><span class="attr">          destination:</span> <span class="string">studyExchange</span></span><br><span class="line">          <span class="comment"># 消息类型</span></span><br><span class="line"><span class="attr">          content-type:</span> <span class="string">application/json</span></span><br><span class="line">          <span class="comment"># 设置绑定的消息服务的具体设置</span></span><br><span class="line"><span class="attr">          binder:</span> <span class="string">defaultRabbit</span></span><br><span class="line">          <span class="string">＃设置分组</span></span><br><span class="line"><span class="attr">          group:</span> <span class="string">groupA</span></span><br></pre></td></tr></table></figure><p>这样只需要将同一应用的不同实例设置为同一个组就可避免单独消费</p></li></ul><hr><p><strong>持久化</strong>：</p><ul><li>没有配置 group，会导致错过消息</li></ul><h2 id="链路追踪"><a href="#链路追踪" class="headerlink" title="链路追踪"></a>链路追踪</h2><p>在微服务框架中，一个由客户端发起的请求在后端系统中会经过多个不同的服务节点调用来协同产生最后的结果请求，每一个前端请求都会形成一条复杂的分布式服务调用链路，链路中任何一环出现高延时或错误都会引起请求最后的失败。</p><p>所以需要一套跟踪的框架去追踪。</p><h3 id="Sleuth-amp-Zipkin"><a href="#Sleuth-amp-Zipkin" class="headerlink" title="Sleuth &amp; Zipkin"></a>Sleuth &amp; Zipkin</h3><p>Sleuth 复制搜集，zipkin 图像化呈现</p><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200605160938.png" alt></p><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200605160918.png" alt></p><h4 id="Zipkin"><a href="#Zipkin" class="headerlink" title="Zipkin"></a>Zipkin</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -fL -o 'zipkin.jar' 'https://repo1.maven.org/maven2/io/zipkin/zipkin-server/2.21.1/zipkin-server-2.21.1-exec.jar'</span><br><span class="line">java -jar zipkin.jar</span><br></pre></td></tr></table></figure><p>浏览器打开 <u><em>localhost:9411/zipkin</em></u></p><h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><ol><li><p>添加依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Sleuth &amp; zipkin --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-zipkin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>配置 yaml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  zipkin:</span></span><br><span class="line"><span class="attr">    base-url:</span> <span class="attr">http://localhost:9411</span></span><br><span class="line"><span class="attr">  sleuth:</span></span><br><span class="line"><span class="attr">    sampler:</span></span><br><span class="line">      <span class="comment"># 采样率值介于 0 ~ 1，1表示全部收集</span></span><br><span class="line"><span class="attr">      probability:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure></li></ol><h2 id="Nacos"><a href="#Nacos" class="headerlink" title="Nacos"></a>Nacos</h2><p><strong><em>Nacos</em></strong>（<strong><em>Na</em></strong>ming, <strong><em>Co</em></strong>nfiguration，<strong><em>S</em></strong>ervice）</p><p>网址：<em><a href="https://nacos.io/zh-cn/" target="_blank" rel="noopener">https://nacos.io/zh-cn/</a></em></p><h3 id="概述-1"><a href="#概述-1" class="headerlink" title="概述"></a>概述</h3><h4 id="是什么-1"><a href="#是什么-1" class="headerlink" title="是什么"></a>是什么</h4><p>注册中心＋配置中心 &lt;==&gt; <em>Eureka</em> + <em>Config</em> + <em>Bus</em>（注册+配置+总线）</p><h4 id="作用-2"><a href="#作用-2" class="headerlink" title="作用"></a>作用</h4><ul><li>服务注册中心</li><li>服务配置中心</li></ul><h4 id="注册中心比较"><a href="#注册中心比较" class="headerlink" title="注册中心比较"></a>注册中心比较</h4><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200605160852.png" alt></p><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200605160841.png" alt></p><p>Nacos 支持 CP 和 AP 的切换</p><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200605160903.png" alt></p><h4 id="安装运行"><a href="#安装运行" class="headerlink" title="安装运行"></a>安装运行</h4><p>环境：Java8 + Maven</p><p>从 <a href="https://github.com/alibaba/nacos/releases" target="_blank" rel="noopener">最新稳定版本</a> 下载 <code>nacos-server-$version.zip</code> 包。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">unzip nacos-server-<span class="variable">$version</span>.zip 或者 tar -xvf nacos-server-<span class="variable">$version</span>.tar.gz</span><br><span class="line"><span class="built_in">cd</span> nacos/bin</span><br></pre></td></tr></table></figure><p><strong>Linux/Unix/Mac</strong></p><p>启动命令(standalone代表着单机模式运行，非集群模式):</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh startup.sh -m standalone</span><br></pre></td></tr></table></figure><p>如果您使用的是ubuntu系统，或者运行脚本报错提示[[符号找不到，可尝试如下运行：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash startup.sh -m standalone</span><br></pre></td></tr></table></figure><p>浏览器打开：<a href="http://localhost:8848/nacos/" target="_blank" rel="noopener">http://localhost:8848/nacos/</a></p><blockquote><p>用户名和密码都是：nacos</p></blockquote><h4 id="服务注册-amp-发现和配置管理"><a href="#服务注册-amp-发现和配置管理" class="headerlink" title="服务注册&amp;发现和配置管理"></a>服务注册&amp;发现和配置管理</h4><p><strong>服务注册</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST 'http://127.0.0.1:8848/nacos/v1/ns/instance?serviceName=nacos.naming.serviceName&amp;ip=20.18.7.10&amp;port=8080'</span><br></pre></td></tr></table></figure><p><strong>服务发现</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X GET 'http://127.0.0.1:8848/nacos/v1/ns/instance/list?serviceName=nacos.naming.serviceName'</span><br></pre></td></tr></table></figure><p><strong>发布配置</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST "http://127.0.0.1:8848/nacos/v1/cs/configs?dataId=nacos.cfg.dataId&amp;group=test&amp;content=HelloWorld"</span><br></pre></td></tr></table></figure><p><strong>获取配置</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X GET "http://127.0.0.1:8848/nacos/v1/cs/configs?dataId=nacos.cfg.dataId&amp;group=test</span><br></pre></td></tr></table></figure><h3 id="服务注册"><a href="#服务注册" class="headerlink" title="服务注册"></a>服务注册</h3><p><strong><em>Nacos</em></strong> 默认支持<u>负载均衡</u></p><h4 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h4><p>启动服务</p><h4 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h4><ol start="0"><li><p>父项目添加依赖管理</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- spring cloud alibaba 2.1.0.RELEASE --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>添加依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>配置 yaml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">nacos-payment-provider</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    nacos:</span></span><br><span class="line"><span class="attr">      discovery:</span></span><br><span class="line"><span class="attr">        server-addr:</span> <span class="attr">localhost:8848</span></span><br><span class="line"></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line"><span class="attr">  endpoints:</span></span><br><span class="line"><span class="attr">    web:</span></span><br><span class="line"><span class="attr">      exposure:</span></span><br><span class="line"><span class="attr">        include:</span> <span class="string">'*'</span></span><br></pre></td></tr></table></figure></li><li><p>启用服务发现</p><p>主启动类加上注解：<code>@EnableDiscoveryClient</code></p></li><li><p>服务调用</p><p>创建 RestTemplate bean，还需要加上 <code>@LoadBalance</code> 注解添加负载均衡，使用服务名来调用服务</p><hr><blockquote><p>Consumer 的应用可能还没像启动一个 Provider 应用那么简单。因为在 Consumer 端需要去调用 Provider 端提供的REST 服务。例子中我们使用最原始的一种方式， 即显示的使用 LoadBalanceClient 和 RestTemolate 结合的方式来访问。 pom.xml 和 application.properties 的配置可以参考 1.2 小结。启动一个 Consumer应用的示例代码如下所示：</p><p><kbd>Note</kbd> <strong>通过带有负载均衡的RestTemplate 和 FeignClient 也是可以访问的。</strong></p></blockquote></li></ol><h3 id="基础配置"><a href="#基础配置" class="headerlink" title="基础配置"></a>基础配置</h3><ol><li><p>添加依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Nacos Config --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Nacos 服务发现 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>修改 YAML 配置</p><p>Nacos 与 springcloud-config 一样，在项目初始化时，要先保证从配置中心进行配置拉取</p><p>拉取配置后，才能保证项目的正常启动。</p><p>springboot 配置文件的加载存在优先级，bootstrap 优先级高于 application</p><ul><li><p><em>bootstrap.yml</em></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">3377</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">nacos-config-client</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    nacos:</span></span><br><span class="line"><span class="attr">      discovery:</span></span><br><span class="line"><span class="attr">        server-addr:</span> <span class="attr">localhost:8848</span></span><br><span class="line"><span class="attr">      config:</span></span><br><span class="line">        <span class="comment"># Nacos 作为配置中心地址</span></span><br><span class="line"><span class="attr">        server-addr:</span> <span class="attr">localhost:8848</span></span><br><span class="line">        <span class="comment"># 指定为 yaml 格式</span></span><br><span class="line"><span class="attr">        file-extension:</span> <span class="string">yaml</span></span><br></pre></td></tr></table></figure></li><li><p><em>application.yml</em></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置环境</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  profiles:</span></span><br><span class="line"><span class="attr">    active:</span> <span class="string">dev</span></span><br></pre></td></tr></table></figure></li></ul></li><li><p>启动类</p><p>与服务注册相同，使用 springcloud 原生注解</p></li><li><p>动态刷新</p><p><code>@Controller</code> 上添加 <code>@RefreshScope</code></p><p>在 Nacos 管理界面更新配置信息后，客户端可以直接感知到配置文件的变化</p></li></ol><blockquote><p><strong>Data ID 命名</strong>：</p><p>在 Nacos Spring Cloud 中，<code>dataId</code> 的完整格式如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; $&#123;prefix&#125;-$&#123;spring.profile.active&#125;.$&#123;file-extension&#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></blockquote><blockquote><ul><li><code>prefix</code> 默认为 <code>spring.application.name</code> 的值，也可以通过配置项 <code>spring.cloud.nacos.config.prefix</code>来配置。</li><li><code>spring.profile.active</code> 即为当前环境对应的 profile，详情可以参考 <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-profiles.html#boot-features-profiles" target="_blank" rel="noopener">Spring Boot文档</a>。 <strong>注意：当 <code>spring.profile.active</code> 为空时，对应的连接符 <code>-</code> 也将不存在，dataId 的拼接格式变成 <code>${prefix}.${file-extension}</code></strong></li><li><code>file-exetension</code> 为配置内容的数据格式，可以通过配置项 <code>spring.cloud.nacos.config.file-extension</code> 来配置。目前只支持 <code>properties</code> 和 <code>yaml</code> 类型。</li></ul></blockquote><h3 id="分类配置"><a href="#分类配置" class="headerlink" title="分类配置"></a>分类配置</h3><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200605160823.png" alt></p><p><em>Nacos</em> 类似与 Java 里面的 package 和 类名，最外层的 <em>namespace</em> 可以区分部署环境，Group 和 DataID 逻辑上区分两个目标对象。</p><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200605160224.png" alt></p><p>默认情况：Namespace=public，Group=DEFAULT_GROUP，Cluster=DEFAULT</p><ul><li><em>Namspace</em> 主要用来实现隔离，比如有开发、测试、生产环境，就可以创建三个 Namespace，不同的 Namespace 之间是隔离的；</li><li><em>Group</em> 可以把不同的微服务划分到同一个分组里面去；</li><li><em>Service</em> 就是微服务，一个 Service 可以包含多个 Cluster，Cluster 是对指定微服务的一个虚拟划分</li></ul><p><kbd style="font-size:1em">Nacos概念</kbd> <em><a href="https://nacos.io/zh-cn/docs/concepts.html" target="_blank" rel="noopener">https://nacos.io/zh-cn/docs/concepts.html</a></em></p><p><strong>命名空间</strong></p><p>用于进行租户粒度的配置隔离。不同的命名空间下，可以存在相同的 Group 或 Data ID 的配置。Namespace 的常用场景之一是<strong>不同环境的配置的区分隔离，例如开发测试环境和生产环境的资源（如配置、服务）隔离等</strong>。</p><p><strong>配置集 ID</strong></p><p>Nacos 中的某个配置集的 ID。配置集 ID 是组织划分配置的维度之一。Data ID 通常用于<strong>组织划分系统的配置集。一个系统或者应用可以包含多个配置集，每个配置集都可以被一个有意义的名称标识</strong>。Data ID 通常采用类 Java 包（如 com.taobao.tc.refund.log.level）的命名规则保证全局唯一性。此命名规则非强制。</p><p><strong>配置分组</strong></p><p>Nacos 中的一组配置集，是组织配置的维度之一。通过一个有意义的字符串（如 Buy 或 Trade ）对配置集进行分组，从而区分 Data ID 相同的配置集。当您在 Nacos 上创建一个配置时，如果未填写配置分组的名称，则配置分组的名称默认采用 DEFAULT_GROUP 。配置分组的常见场景：<strong>不同的应用或组件使用了相同的配置类型，如 database_url 配置和 MQ_topic 配置。</strong></p><h4 id="DataID"><a href="#DataID" class="headerlink" title="DataID"></a>DataID</h4><p>指定<code>spring.profile.active</code> 和配置文件的 DataID 来使不同环境下读取不同的配置</p><h4 id="Group"><a href="#Group" class="headerlink" title="Group"></a>Group</h4><p>在配置文件中可以指定 group</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">nacos-config-client</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    nacos:</span></span><br><span class="line"><span class="attr">      discovery:</span></span><br><span class="line"><span class="attr">        server-addr:</span> <span class="attr">localhost:8848</span></span><br><span class="line"><span class="attr">      config:</span></span><br><span class="line">        <span class="comment"># Nacos 作为配置中心地址</span></span><br><span class="line"><span class="attr">        server-addr:</span> <span class="attr">localhost:8848</span></span><br><span class="line">        <span class="comment"># 指定为 yaml 格式</span></span><br><span class="line"><span class="attr">        file-extension:</span> <span class="string">yaml</span></span><br><span class="line">        <span class="comment"># group</span></span><br><span class="line"><span class="attr">        group:</span> <span class="string">TEST_GROUP</span></span><br></pre></td></tr></table></figure><h4 id="Namespace"><a href="#Namespace" class="headerlink" title="Namespace"></a>Namespace</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">nacos-config-client</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    nacos:</span></span><br><span class="line"><span class="attr">      discovery:</span></span><br><span class="line"><span class="attr">        server-addr:</span> <span class="attr">localhost:8848</span></span><br><span class="line"><span class="attr">      config:</span></span><br><span class="line">        <span class="comment"># Nacos 作为配置中心地址</span></span><br><span class="line"><span class="attr">        server-addr:</span> <span class="attr">localhost:8848</span></span><br><span class="line">        <span class="comment"># 指定为 yaml 格式</span></span><br><span class="line"><span class="attr">        file-extension:</span> <span class="string">yaml</span></span><br><span class="line">        <span class="comment"># group</span></span><br><span class="line"><span class="attr">        group:</span> <span class="string">DEV_GROUP</span></span><br><span class="line">        <span class="comment"># 命名空间 ID</span></span><br><span class="line"><span class="attr">        namespace:</span> <span class="number">78</span><span class="string">df1403-40c7-4c0a-9647-63a1583d2336</span></span><br></pre></td></tr></table></figure><h3 id="集群"><a href="#集群" class="headerlink" title="集群"></a>集群</h3><h4 id="集群模式部署"><a href="#集群模式部署" class="headerlink" title="集群模式部署"></a>集群模式部署</h4><p>这个快速开始手册是帮忙您快速在你的电脑上，下载安装并使用Nacos，部署生产使用的集群模式。</p><h4 id="集群部署架构图"><a href="#集群部署架构图" class="headerlink" title="集群部署架构图"></a>集群部署架构图</h4><p>因此开源的时候推荐用户把所有服务列表放到一个vip下面，然后挂到一个域名下面</p><blockquote><p>VIP：虚拟IP，例如 Nginx 集群</p></blockquote><p><a href="http://ip1/" target="_blank" rel="noopener">http://ip1</a>:port/openAPI 直连ip模式，机器挂则需要修改ip才可以使用。</p><p><a href="http://vip/" target="_blank" rel="noopener">http://VIP</a>:port/openAPI 挂载VIP模式，直连vip即可，下面挂server真实ip，可读性不好。</p><p><a href="http://nacos.com/" target="_blank" rel="noopener">http://nacos.com</a>:port/openAPI 域名 + VIP模式，可读性好，而且换ip方便，推荐模式</p><p><img src="https://cdn.nlark.com/yuque/0/2019/jpeg/338441/1561258986171-4ddec33c-a632-4ec3-bfff-7ef4ffc33fb9.jpeg" alt="deployDnsVipMode.jpg"></p><blockquote><p><a href="https://nacos.io/zh-cn/docs/cluster-mode-quick-start.html" target="_blank" rel="noopener">https://nacos.io/zh-cn/docs/cluster-mode-quick-start.html</a></p></blockquote><p>Nacos 默认使用嵌入式数据库（derby）保存数据，如果启动多个默认配置的 Nacos 节点，数据存储存在一致性问题，为了解决这个问题，Nacos 采用了集中式存储的放啊是来支持集群化部署，目前只支持 MySQL 的存储。</p><h4 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h4><ul><li><p>部署 Nacos 集群</p><ul><li><p>Clone 项目，进入根目录</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/paderlol/nacos-docker.git</span><br><span class="line">cd nacos-docker</span><br></pre></td></tr></table></figure></li><li><p>修改配置</p><p><em>example/cluster-ip.yaml</em></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">"2"</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"><span class="attr">  nacos1:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">nacos/nacos-server:latest</span></span><br><span class="line"><span class="attr">    container_name:</span> <span class="string">nacos1</span></span><br><span class="line">    <span class="comment"># 指定网络名和ip</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="attr">      Utils:</span></span><br><span class="line"><span class="attr">        ipv4_address:</span> <span class="number">169.1</span><span class="number">.0</span><span class="number">.6</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">./cluster-logs/nacos1:/home/nacos/logs</span> </span><br><span class="line"><span class="attr">    env_file:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">../env/nacos-ip.env</span></span><br><span class="line"><span class="attr">    restart:</span> <span class="string">on-failure</span> </span><br><span class="line"></span><br><span class="line"><span class="attr">  nacos2:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">nacos/nacos-server:latest</span></span><br><span class="line"><span class="attr">    container_name:</span> <span class="string">nacos2</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="attr">      Utils:</span></span><br><span class="line"><span class="attr">        ipv4_address:</span> <span class="number">169.1</span><span class="number">.0</span><span class="number">.7</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">./cluster-logs/nacos2:/home/nacos/logs</span> </span><br><span class="line"><span class="attr">    env_file:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">../env/nacos-ip.env</span></span><br><span class="line"><span class="attr">    restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  nacos_netcos3:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">nacos/nacos-server:latest</span></span><br><span class="line"><span class="attr">    container_name:</span> <span class="string">nacos3</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="attr">      Utils:</span></span><br><span class="line"><span class="attr">        ipv4_address:</span> <span class="number">169.1</span><span class="number">.0</span><span class="number">.8</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">./cluster-logs/nacos2:/home/nacos/logs</span></span><br><span class="line"><span class="attr">    env_file:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">../env/nacos-ip.env</span></span><br><span class="line"><span class="attr">    restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line"><span class="attr">  Utils:</span></span><br><span class="line">    <span class="comment"># 引入外部网络，默认是创建了一个新的网络</span></span><br><span class="line"><span class="attr">    external:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">Utils</span></span><br></pre></td></tr></table></figure><p><em>env/nacos-ip.env</em></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#nacos dev env</span><br><span class="line">#配置集群ip、mysql信息</span><br><span class="line">NACOS_SERVERS=169.1.0.6:8848 169.1.0.7:8848 169.1.0.8:8848</span><br><span class="line">MYSQL_SERVICE_HOST=172.17.0.1</span><br><span class="line">MYSQL_SERVICE_DB_NAME=nacos_config</span><br><span class="line">MYSQL_SERVICE_PORT=3306</span><br><span class="line">MYSQL_SERVICE_USER=root</span><br><span class="line">MYSQL_SERVICE_PASSWORD=mysqlpass</span><br></pre></td></tr></table></figure></li><li><p>拉取进行生成容器</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose -f example/cluster-ip.yaml up</span><br></pre></td></tr></table></figure></li></ul></li><li><p>配置 Nginx</p><ul><li><p>使用 docker 创建镜像，并设置容器的网络ip</p></li><li><p>配置 nginx</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"># 设置nacos集群ip</span><br><span class="line">upstream cluster &#123;</span><br><span class="line">    server 169.1.0.6:8848;</span><br><span class="line">    server 169.1.0.7:8848;</span><br><span class="line">    server 169.1.0.8:8848;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  localhost;</span><br><span class="line"></span><br><span class="line">    #charset koi8-r;</span><br><span class="line">    #access_log  /var/log/nginx/host.access.log  main;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root    /usr/share/nginx/html;</span><br><span class="line">        index   index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">	# 匹配路径，设置代理到集群上</span><br><span class="line">    location /nacos &#123;</span><br><span class="line">        #root   /usr/share/nginx/html;</span><br><span class="line">        #index  index.html index.htm;</span><br><span class="line">        proxy_pass http://cluster/nacos;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    #error_page  404              /404.html;</span><br><span class="line"></span><br><span class="line">    # redirect server error pages to the static page /50x.html</span><br><span class="line">    #</span><br><span class="line">    error_page   500 502 503 504  /50x.html;</span><br><span class="line">    location = /50x.html &#123;</span><br><span class="line">        root   /usr/share/nginx/html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # proxy the PHP scripts to Apache listening on 127.0.0.1:80</span><br><span class="line">    #</span><br><span class="line">    #location ~ \.php$ &#123;</span><br><span class="line">    #    proxy_pass   http://127.0.0.1;</span><br><span class="line">    #&#125;</span><br><span class="line"></span><br><span class="line">    # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span><br><span class="line">    #</span><br><span class="line">    #location ~ \.php$ &#123;</span><br><span class="line">    #    root           html;</span><br><span class="line">    #    fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">    #    fastcgi_index  index.php;</span><br><span class="line">    #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</span><br><span class="line">    #    include        fastcgi_params;</span><br><span class="line">    #&#125;</span><br><span class="line"></span><br><span class="line">    # deny access to .htaccess files, if Apache&apos;s document root</span><br><span class="line">    # concurs with nginx&apos;s one</span><br><span class="line">    #</span><br><span class="line">    #location ~ /\.ht &#123;</span><br><span class="line">    #    deny  all;</span><br><span class="line">    #&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul></li><li><p>最后nacos的yaml配置中直接填nginx ip就可以</p></li></ul><h2 id="Sentinel"><a href="#Sentinel" class="headerlink" title="Sentinel"></a>Sentinel</h2><h3 id="概述-2"><a href="#概述-2" class="headerlink" title="概述"></a>概述</h3><blockquote><p>Hystrix：</p><ul><li>需要手动搭建平台</li><li>没有 Web 界面可以细粒度化配置</li></ul><p>Sentinel:</p><ul><li>单独的一个组件</li><li>web 界面配置</li></ul></blockquote><p>随着微服务的流行，服务和服务之间的稳定性变得越来越重要。Sentinel 以流量为切入点，从流量控制、熔断降级、系统负载保护等多个维度保护服务的稳定性。</p><p>Sentinel 具有以下特征:</p><ul><li><strong>丰富的应用场景</strong>：Sentinel 承接了阿里巴巴近 10 年的双十一大促流量的核心场景，例如秒杀（即突发流量控制在系统容量可以承受的范围）、消息削峰填谷、集群流量控制、实时熔断下游不可用应用等。</li><li><strong>完备的实时监控</strong>：Sentinel 同时提供实时的监控功能。您可以在控制台中看到接入应用的单台机器秒级数据，甚至 500 台以下规模的集群的汇总运行情况。</li><li><strong>广泛的开源生态</strong>：Sentinel 提供开gaishu箱即用的与其它开源框架/库的整合模块，例如与 Spring Cloud、Dubbo、gRPC 的整合。您只需要引入相应的依赖并进行简单的配置即可快速地接入 Sentinel。</li><li><strong>完善的 SPI 扩展点</strong>：Sentinel 提供简单易用、完善的 SPI 扩展接口。您可以通过实现扩展接口来快速地定制逻辑。例如定制规则管理、适配动态数据源等。</li></ul><p>Sentinel 的主要特性：</p><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200605160107.png" alt></p><p>简单来说，Sentinel 的功能：</p><ul><li>服务雪崩</li><li>服务降级</li><li>服务熔断</li><li>服务限流</li></ul><h4 id="组成-1"><a href="#组成-1" class="headerlink" title="组成"></a>组成</h4><ul><li>核心库（Java客户端），不依赖于任何框架/库，能够运行于所有的 Java 环境</li><li>控制体（Dashboard），基于 Spring Boot 开发，可以直接运行</li></ul><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><p><em>jar</em> 包地址：<u><a href="https://github.com/alibaba/Sentinel/releases" target="_blank" rel="noopener">https://github.com/alibaba/Sentinel/releases</a></u>，下载 dashboard</p><h3 id="使用-1"><a href="#使用-1" class="headerlink" title="使用"></a>使用</h3><h4 id="服务端-1"><a href="#服务端-1" class="headerlink" title="服务端"></a>服务端</h4><p>运行 jar 包</p><h4 id="客户端-1"><a href="#客户端-1" class="headerlink" title="客户端"></a>客户端</h4><ol><li><p>添加依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- sentinel --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 后续做持久化 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.csp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel-datasource-nacos<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>yaml 配置</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">cloudalibaba-sentinel-service</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    nacos:</span></span><br><span class="line"><span class="attr">      discovery:</span></span><br><span class="line"><span class="attr">        server-addr:</span> <span class="attr">localhost:8848</span></span><br><span class="line"><span class="attr">    sentinel:</span></span><br><span class="line"><span class="attr">      transport:</span></span><br><span class="line"><span class="attr">        dashboard:</span> <span class="attr">localhost:12345</span></span><br><span class="line">        <span class="comment"># 默认8719，如果被占用会自动从8719开始+1扫描</span></span><br><span class="line"><span class="attr">        port:</span> <span class="number">8719</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 监控</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line"><span class="attr">  endpoints:</span></span><br><span class="line"><span class="attr">    web:</span></span><br><span class="line"><span class="attr">      exposure:</span></span><br><span class="line"><span class="attr">        include:</span> <span class="string">'*'</span></span><br></pre></td></tr></table></figure></li><li><p>编写 controller 并访问，就可以看到 sentinel 控制台显示的信息</p><blockquote><p>sentinel 是懒加载，只有当访问了之后才会显示出来</p></blockquote></li></ol><h3 id="流量控制（流控，flow-control）"><a href="#流量控制（流控，flow-control）" class="headerlink" title="流量控制（流控，flow control）"></a>流量控制（流控，<em>flow</em> <em>control</em>）</h3><blockquote><p><em>Doc</em>: <a href="https://github.com/alibaba/Sentinel/wiki/流量控制" target="_blank" rel="noopener">流量控制</a></p></blockquote><h4 id="概述-3"><a href="#概述-3" class="headerlink" title="概述"></a>概述</h4><p><strong>流量控制</strong>（flow control），其原理是监控应用流量的 QPS 或并发线程数等指标，当达到指定的阈值时对流量进行控制，以避免被瞬时的流量高峰冲垮，从而保障应用的高可用性。</p><p>一条限流规则主要由下面几个因素组成，我们可以组合这些元素来实现不同的限流效果：</p><ul><li><code>resource</code>：资源名，即限流规则的作用对象</li><li><code>count</code>：限流阈值</li><li><code>grade</code>： 限流阈值类型（QPS 或并发线程数）</li><li><code>limitApp</code>： 流控针对的调用来源，若为 <code>default</code> 则不区分调用来源</li><li><code>strategy</code>： 调用关系限流策略</li><li><code>controlBehavior</code>： 流量控制效果（直接拒绝、Warm Up、匀速排队）</li></ul><h4 id="流控模式"><a href="#流控模式" class="headerlink" title="流控模式"></a>流控模式</h4><h5 id="设置"><a href="#设置" class="headerlink" title="设置"></a>设置</h5><ul><li><p>资源名</p><p>唯一资源，默认请求路径</p></li><li><p>针对来源</p><p>Sentinel 可以针对调用者进行限流，填写服务名，默认 default（不区分来源）</p></li><li><p>阈值类型/单机阈值</p><ul><li><p>QPS（每秒的请求数量）</p><p>当调用该 api 的 QPS 达到阈值的时候，进行限流</p></li><li><p>线程数</p><p>当调用该 api 的线程数达到阈值的时候，进行限流</p><blockquote><p>处理该 api 请求的线程数达到阈值，再来请求就会直接拒绝；</p><p>而 QPS 是每秒并发请求数的限制；这个是最大并发请求线程树的限制。</p><p>当选择 <u>线程数</u> 时，【流控效果】只能是 <u>快速失败</u>。</p></blockquote></li></ul></li><li><p>流控模式</p><ul><li><p>直接</p><p>当 api 达到限流条件时，直接限流</p></li><li><p>关联</p><p>当关联的资源达到阈值时，限流</p><blockquote><p>当两个资源之间具有资源争抢或者依赖关系的时候，这两个资源便具有了关联。比如对数据库同一个字段的读操作和写操作存在争抢，读的速度过高会影响写得速度，写的速度过高会影响读的速度。如果放任读写操作争抢资源，则争抢本身带来的开销会降低整体的吞吐量。可使用关联限流来避免具有关联关系的资源之间过度的争抢</p></blockquote></li><li><p>链路</p><p>只记录指定链路上的流量（指定资源从入口资源进来的流量，如果达到阈值，就进行限流），api 级别的针对来源</p></li></ul></li><li><p>流控效果（只有是 QPS 时才可以设置）</p><ul><li><p>快速失败</p><p><strong>直接拒绝</strong>（<code>RuleConstant.CONTROL_BEHAVIOR_DEFAULT</code>）方式是默认的流量控制方式，当QPS超过任意规则的阈值后，新的请求就会被立即拒绝，拒绝方式为抛出<code>FlowException</code>。这种方式适用于对系统处理能力确切已知的情况下，比如通过压测确定了系统的准确水位时。</p></li><li><p>Warm Up</p><p>当流量突然增大的时候，我们常常会希望系统从空闲状态到繁忙状态的切换的时间长一些。即如果系统在此之前长期处于空闲的状态，我们希望处理请求的数量是缓步的增多，经过预期的时间以后，到达系统处理请求个数的最大值。Warm Up（冷启动，预热）模式就是为了实现这个目的的。</p><p>默认 <code>coldFactor</code> 为 3，即请求 QPS 从 <code>threshold / 3</code> 开始，经预热时长逐渐升至设定的 QPS 阈值。</p><blockquote><p>限流－冷启动：<a href="https://github.com/alibaba/Sentinel/wiki/限流---冷启动" target="_blank" rel="noopener">冷启动</a></p><blockquote><p>设置界面单位是 5</p></blockquote><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200605160022.png" alt></p><p>可以看到，最开始的阈值是 100/3，慢慢的再一段时间内才开始上升到设置的 100</p></blockquote></li><li><p>排队等待</p><p>匀速排队（<code>RuleConstant.CONTROL_BEHAVIOR_RATE_LIMITER</code>）方式会严格控制请求通过的间隔时间，也即是让请求以均匀的速度通过，对应的是漏桶算法。</p><p><a href="https://en.wikipedia.org/wiki/Leaky_bucket" target="_blank" rel="noopener">Leaky Bucket</a> 对应 <a href="https://github.com/alibaba/Sentinel/wiki/流量控制" target="_blank" rel="noopener">流量整形</a> 中的<strong>匀速器</strong>。它的中心思想是，以固定的间隔时间让请求通过。当请求到来的时候，如果当前请求距离上个通过的请求通过的时间间隔不小于预设值，则让当前请求通过；否则，计算当前请求的预期通过时间，如果该请求的预期通过时间小于规则预设的 timeout 时间，则该请求会等待直到预设时间到来通过（排队等待处理）；若预期的通过时间超出最大排队时长，则直接拒接这个请求。</p><blockquote><p><a href="https://github.com/alibaba/Sentinel/wiki/流量控制-匀速排队模式" target="_blank" rel="noopener">流量控制 - 匀速器模式</a></p><blockquote><p>设置界面单位是 ms</p></blockquote><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200605160010.png" alt></p><p>设置 QPS = 10，每秒匀速 10 个，间隔时间：1000ms / 10 = 100ms</p><p>超时时间 20 * 1000ms = 20s</p><p>如果请求等待时间超过 20s，就会失败：</p><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200605155957.png" alt></p><blockquote><p>Jmeter 绝对并发：</p><p><img src="../../../%25E6%25A1%258C%25E9%259D%25A2/SpringCloud/image-20200523181903368.png" alt="image-20200523181903368"></p></blockquote></blockquote></li></ul></li></ul><h3 id="熔断降级"><a href="#熔断降级" class="headerlink" title="熔断降级"></a>熔断降级</h3><h4 id="概述-4"><a href="#概述-4" class="headerlink" title="概述"></a>概述</h4><p>除了流量控制以外，<u>对调用链路中不稳定的资源进行熔断降级</u>也是保障高可用的重要措施之一。由于调用关系的复杂性，如果调用链路中的某个资源不稳定，最终会导致请求发生堆积。Sentinel <strong>熔断降级</strong>会在调用链路中某个资源出现不稳定状态时（例如调用超时或异常比例升高），对这个资源的调用进行限制，让请求快速失败，避免影响到其它的资源而导致级联错误。</p><p>当资源被降级后，在接下来的降级时间窗口之内，对该资源的调用都自动熔断（默认行为是抛出 <code>DegradeException</code>）。</p><p>==❈ Setinel 的断路器没有半开状态：半开状态时系统会自动检测是否请求有异常，没有异常就关闭断路器恢复使用，有异常就继续打开断路器不可用（Hystrix）。==</p><h4 id="策略"><a href="#策略" class="headerlink" title="策略"></a>策略</h4><blockquote><p>源码：com.alibaba.csp.sentinel.slots.block.degrade.<strong><em>DegradeRule</em></strong></p></blockquote><p>我们通常用以下几种方式来衡量资源是否处于稳定的状态：</p><ul><li><p>平均响应时间 (<code>DEGRADE_GRADE_RT</code>)：当资源的平均响应时间超过阈值（<code>DegradeRule</code> 中的 <code>count</code>，以 ms 为单位）之后，资源进入<u>准降级状态</u>。接下来如果持续进入 <strong><em>5</em></strong> 个请求，它们的 RT 都持续超过这个阈值，那么在接下的时间窗口（<code>DegradeRule</code> 中的 <code>timeWindow</code>，以 s 为单位）之内，对这个方法的调用都会自动地返回（抛出 <code>DegradeException</code>）。注意 Sentinel 默认统计的 RT 上限是 4900 ms，<strong>超出此阈值的都会算作 4900 ms</strong>，若需要变更此上限可以通过启动配置项 <code>-Dcsp.sentinel.statistic.max.rt=xxx</code> 来配置。</p><blockquote><p>Github Wiki 没有强调 5 个请求</p></blockquote></li><li><p>异常比例 (<code>DEGRADE_GRADE_EXCEPTION_RATIO</code>)：当资源的每秒请求量 &gt;= N（可配置），并且每秒异常总数占通过量的比值超过阈值（<code>DegradeRule</code> 中的 <code>count</code>）之后，资源进入降级状态，即在接下的时间窗口（<code>DegradeRule</code> 中的 <code>timeWindow</code>，以 s 为单位）之内，对这个方法的调用都会自动地返回。异常比率的阈值范围是 <code>[0.0, 1.0]</code>，代表 0% - 100%。</p><blockquote><p>N 默认是5，目前没有找到配置 N 的地方</p></blockquote></li><li><p>异常数 (<code>DEGRADE_GRADE_EXCEPTION_COUNT</code>)：当资源近 1 分钟的异常数目超过阈值之后会进行熔断。注意由于统计时间窗口是分钟级别的，若 <code>timeWindow</code> 小于 60s，则结束熔断状态后仍可能再进入熔断状态。</p></li></ul><p>注意：异常降级仅针对业务异常，对 Sentinel 限流降级本身的异常（<code>BlockException</code>）不生效。为了统计异常比例或异常数，需要通过 <code>Tracer.trace(ex)</code> 记录业务异常。示例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Entry entry = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  entry = SphU.entry(key, EntryType.IN, key);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Write your biz code here.</span></span><br><span class="line">  <span class="comment">// &lt;&lt;BIZ CODE&gt;&gt;</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!BlockException.isBlockException(t)) &#123;</span><br><span class="line">    Tracer.trace(t);</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (entry != <span class="keyword">null</span>) &#123;</span><br><span class="line">    entry.exit();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>开源整合模块，如 Sentinel Dubbo Adapter, Sentinel Web Servlet Filter 或 <code>@SentinelResource</code> 注解会自动统计业务异常，无需手动调用。</p><h3 id="热点key"><a href="#热点key" class="headerlink" title="热点key"></a>热点key</h3><h4 id="概述-5"><a href="#概述-5" class="headerlink" title="概述"></a>概述</h4><p>何为热点？热点即经常访问的数据。很多时候我们希望统计某个热点数据中访问频次最高的 Top K 数据，并对其访问进行限制。比如：</p><ul><li>商品 ID 为参数，统计一段时间内最常购买的商品 ID 并进行限制</li><li>用户 ID 为参数，针对一段时间内频繁访问的用户 ID 进行限制</li></ul><p>热点参数限流会统计传入参数中的热点参数，并根据配置的限流阈值与模式，对包含热点参数的资源调用进行限流。<strong>热点参数限流可以看做是一种特殊的流量控制，仅对包含热点参数的资源调用生效</strong>。</p><p>Sentinel 利用 <strong><em>LRU</em></strong> 策略统计最近最常访问的热点参数，结合<strong>令牌桶算法</strong>来进行参数级别的流控。热点参数限流<u>支持集群模式</u>。</p><h4 id="简单使用"><a href="#简单使用" class="headerlink" title="简单使用"></a>简单使用</h4><p>用 <code>@SentineResource</code> 注解，设置参数，同时在控制台设置参数索引、阈值、时间窗口等参数进行热点key限流；</p><blockquote><p>不使用注解无效</p></blockquote><h4 id="参数例外项"><a href="#参数例外项" class="headerlink" title="参数例外项"></a>参数例外项</h4><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200605155942.png" alt></p><p>偶尔期望参数是某个特殊值时，限流值要特殊设置。</p><blockquote><p>仅支持基本类型和<em>String</em></p></blockquote><h3 id="系统规则（系统自适应限流）"><a href="#系统规则（系统自适应限流）" class="headerlink" title="系统规则（系统自适应限流）"></a>系统规则（系统自适应限流）</h3><p>Sentinel 系统自适应限流从<strong>整体维度</strong>对应用入口流量进行控制，结合应用的 Load、CPU 使用率、总体平均 RT、入口 QPS 和并发线程数等几个维度的监控指标，通过自适应的流控策略，让系统的入口流量和系统的负载达到一个平衡，让系统尽可能跑在最大吞吐量的同时保证系统整体的稳定性。</p><p>系统保护规则是从应用级别的入口流量进行控制，从单台机器的 load、CPU 使用率、平均 RT、入口 QPS 和并发线程数等几个维度监控应用指标，让系统尽可能跑在最大吞吐量的同时保证系统整体的稳定性。</p><p><u>系统保护规则是应用整体维度的，而不是资源维度的</u>，并且<strong>仅对入口流量生效</strong>。入口流量指的是进入应用的流量（<code>EntryType.IN</code>），比如 Web 服务或 Dubbo 服务端接收的请求，都属于入口流量。</p><p>系统规则支持以下的模式：</p><ul><li><p><strong>Load 自适应</strong>（仅对 Linux/Unix-like 机器生效）：系统的 load1 作为启发指标，进行自适应系统保护。当系统 load1 超过设定的启发值，且系统当前的并发线程数超过估算的系统容量时才会触发系统保护（BBR 阶段）。系统容量由系统的 <code>maxQps * minRt</code> 估算得出。设定参考值一般是 <code>CPU cores * 2.5</code>。</p></li><li><p><strong>CPU usage</strong>（1.5.0+ 版本）：当系统 CPU 使用率超过阈值即触发系统保护（取值范围 0.0-1.0），比较灵敏。</p></li><li><p><strong>平均 RT</strong>：当单台机器上所有入口流量的平均 RT 达到阈值即触发系统保护，单位是毫秒。</p></li><li><p><strong>并发线程数</strong>：当单台机器上所有入口流量的并发线程数达到阈值即触发系统保护。</p></li><li><p><strong>入口 QPS</strong>：当单台机器上所有入口流量的 QPS 达到阈值即触发系统保护。</p></li></ul><h3 id="SentinelResource"><a href="#SentinelResource" class="headerlink" title="@SentinelResource"></a>@SentinelResource</h3><h4 id="概述-6"><a href="#概述-6" class="headerlink" title="概述"></a>概述</h4><p>Sentinel 提供了 <code>@SentinelResource</code> 注解用于定义资源，并提供了 AspectJ 的扩展用于自动定义资源、处理 <code>BlockException</code> 等。使用 <a href="https://github.com/alibaba/Sentinel/tree/master/sentinel-extension/sentinel-annotation-aspectj" target="_blank" rel="noopener">Sentinel Annotation AspectJ Extension</a> 的时候需要引入以下依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.csp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel-annotation-aspectj<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>x.y.z<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>注意：注解方式埋点不支持 private 方法。</p></blockquote><h4 id="参数说明"><a href="#参数说明" class="headerlink" title="参数说明"></a>参数说明</h4><p><code>@SentinelResource</code> 用于定义资源，并提供可选的异常处理和 fallback 配置项。 <code>@SentinelResource</code> 注解包含以下属性：</p><ul><li><p><code>value</code>：资源名称，必需项（不能为空）</p></li><li><p><code>entryType</code>：entry 类型，可选项（默认为 <code>EntryType.OUT</code>）</p></li><li><p><code>blockHandler</code> / <code>blockHandlerClass</code>: <code>blockHandler</code> 对应处理 <code>BlockException</code> 的函数名称，可选项。blockHandler 函数访问范围需要是 <code>public</code>，返回类型需要与原方法相匹配，<u>参数类型需要和原方法相匹配并且最后加一个额外的参数，类型为 <code>BlockException</code></u>。blockHandler 函数默认需要和原方法<u>在同一个类</u>中。</p><hr><p>若希望使用其他类的函数，则可以指定 <code>blockHandlerClass</code> 为对应的类的 <code>Class</code> 对象，注意对应的函数==必需为 <strong><em>static</em></strong> 函数==，否则无法解析。</p><blockquote><p>如果被热点限流，且没有设置这个参数，就会直接返回异常错误页面</p><hr><p><strong>仅被限流时会处理</strong>，运行时异常不会处理</p></blockquote></li><li><p><code>fallback</code>/<code>fallbackClass</code>：fallback 函数名称，可选项，用于在<u>抛出异常</u>的时候提供 fallback 处理逻辑。fallback 函数可以针对所有类型的异常（除了<code>exceptionsToIgnore</code> 里面排除掉的异常类型）进行处理。fallback 函数签名和位置要求：</p><ul><li>返回值类型必须与原函数返回值类型一致；</li><li>方法参数列表需要和原函数一致，或者可以额外多一个 <code>Throwable</code> 类型的参数用于接收对应的异常。</li><li>fallback 函数默认需要和原方法在同一个类中。若希望使用其他类的函数，则可以指定 <code>fallbackClass</code> 为对应的类的 <code>Class</code> 对象，注意对应的函数必需为 static 函数，否则无法解析。</li></ul></li><li><p><code>defaultFallback</code>（since 1.6.0）：默认的 fallback 函数名称，可选项，通常用于通用的 fallback 逻辑（即可以用于很多服务或方法）。默认 fallback 函数可以针对所有类型的异常（除了 <code>exceptionsToIgnore</code> 里面排除掉的异常类型）进行处理。若同时配置了 fallback 和 defaultFallback，则只有 fallback 会生效。defaultFallback 函数签名要求：</p><ul><li><u>返回值类型必须与原函数返回值类型一致；</u></li><li><u>方法参数列表需要为空，或者可以额外多一个 <code>Throwable</code> 类型的参数用于接收对应的异常</u>。</li><li>defaultFallback 函数默认需要和原方法在同一个类中。若希望使用其他类的函数，则可以指定 <code>fallbackClass</code> 为对应的类的 <code>Class</code> 对象，注意对应的函数必需为 static 函数，否则无法解析。</li></ul></li><li><p><code>exceptionsToIgnore</code>（since 1.6.0）：用于指定哪些异常被排除掉，不会计入异常统计中，也不会进入 fallback 逻辑中，而是会原样抛出。</p></li></ul><blockquote><p>注：1.6.0 之前的版本 fallback 函数只针对降级异常（<code>DegradeException</code>）进行处理，<strong>不能针对业务异常进行处理</strong>。</p></blockquote><p>特别地，若 blockHandler 和 fallback 都进行了配置，则被限流降级而抛出 <code>BlockException</code> 时只会进入 <code>blockHandler</code> 处理逻辑。若未配置 <code>blockHandler</code>、<code>fallback</code> 和 <code>defaultFallback</code>，则被限流降级时会将 <code>BlockException</code> <strong>直接抛出</strong>（若方法本身未定义 throws BlockException 则会被 JVM 包装一层 <code>UndeclaredThrowableException</code>）。</p><p>示例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对应的 `handleException` 函数需要位于 `ExceptionUtil` 类中，并且必须为 static 函数.</span></span><br><span class="line">    <span class="meta">@SentinelResource</span>(value = <span class="string">"test"</span>, blockHandler = <span class="string">"handleException"</span>, blockHandlerClass = &#123;ExceptionUtil.class&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Test"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 原函数</span></span><br><span class="line">    <span class="meta">@SentinelResource</span>(value = <span class="string">"hello"</span>, blockHandler = <span class="string">"exceptionHandler"</span>, fallback = <span class="string">"helloFallback"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">(<span class="keyword">long</span> s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">"Hello at %d"</span>, s);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Fallback 函数，函数签名与原函数一致或加一个 Throwable 类型的参数.</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">helloFallback</span><span class="params">(<span class="keyword">long</span> s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">"Halooooo %d"</span>, s);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Block 异常处理函数，参数最后多一个 BlockException，其余与原函数一致.</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">exceptionHandler</span><span class="params">(<span class="keyword">long</span> s, BlockException ex)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Do some log here.</span></span><br><span class="line">        ex.printStackTrace();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Oops, error occurred at "</span> + s;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>从 1.4.0 版本开始，注解方式定义资源支持自动统计业务异常，无需手动调用 <code>Tracer.trace(ex)</code> 来记录业务异常。Sentinel 1.4.0 以前的版本需要自行调用 <code>Tracer.trace(ex)</code> 来记录业务异常。</p><blockquote><p>SpringCloud 不需要额外配置就可以使用注解，基于 AOP （SpringMVC、SpringBoot）都需要额外配置。</p></blockquote><h4 id="自定义限流处理"><a href="#自定义限流处理" class="headerlink" title="自定义限流处理"></a>自定义限流处理</h4><p>通过设置属性 <code>blockHandlerClass</code> 来将兜底方法与业务代码分开</p><hr><h5 id="Feign"><a href="#Feign" class="headerlink" title="Feign"></a>Feign</h5><p>需要在配置文件中开启 sentinel 对 feign 的支持：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">feign.sentinel.enabled=true</span><br></pre></td></tr></table></figure><h4 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h4><p>微服务重启或 Sentinel 重启都会丢失配置规则；</p><p>可以将 sentinel 的配置保存在 Nacos 上或 Redis 中；</p><blockquote><p>参考：<a href="https://github.com/alibaba/Sentinel/wiki/在生产环境中使用-Sentinel" target="_blank" rel="noopener">生产环境中使用-Sentinel</a></p><p>一般来说，规则的推送有下面三种模式:</p><table><thead><tr><th>推送模式</th><th>说明</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td><a href="https://github.com/alibaba/Sentinel/wiki/在生产环境中使用-Sentinel#原始模式" target="_blank" rel="noopener">原始模式</a></td><td>API 将规则推送至客户端并直接更新到内存中，扩展写数据源（<a href="https://github.com/alibaba/Sentinel/wiki/动态规则扩展" target="_blank" rel="noopener"><code>WritableDataSource</code></a>）</td><td>简单，无任何依赖</td><td>不保证一致性；规则保存在内存中，重启即消失。严重不建议用于生产环境</td></tr><tr><td><a href="https://github.com/alibaba/Sentinel/wiki/在生产环境中使用-Sentinel#Pull模式" target="_blank" rel="noopener">Pull 模式</a></td><td>扩展写数据源（<a href="https://github.com/alibaba/Sentinel/wiki/动态规则扩展" target="_blank" rel="noopener"><code>WritableDataSource</code></a>）， 客户端主动向某个规则管理中心定期轮询拉取规则，这个规则中心可以是 RDBMS、文件 等</td><td>简单，无任何依赖；规则持久化</td><td>不保证一致性；实时性不保证，拉取过于频繁也可能会有性能问题。</td></tr><tr><td><strong><a href="https://github.com/alibaba/Sentinel/wiki/在生产环境中使用-Sentinel#Push模式" target="_blank" rel="noopener">Push 模式</a></strong></td><td>扩展读数据源（<a href="https://github.com/alibaba/Sentinel/wiki/动态规则扩展" target="_blank" rel="noopener"><code>ReadableDataSource</code></a>），规则中心统一推送，客户端通过注册监听器的方式时刻监听变化，比如使用 Nacos、Zookeeper 等配置中心。这种方式有更好的实时性和一致性保证。<strong>生产环境下一般采用 push 模式的数据源。</strong></td><td>规则持久化；一致性；快速</td><td>引入第三方依赖</td></tr></tbody></table></blockquote><h5 id="持久化到-Nacos"><a href="#持久化到-Nacos" class="headerlink" title="持久化到 Nacos"></a>持久化到 Nacos</h5><ol><li><p>添加依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 后续做持久化 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.csp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel-datasource-nacos<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>修改 yaml 配置</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">cloudalibaba-sentinel-service</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    nacos:</span></span><br><span class="line"><span class="attr">      discovery:</span></span><br><span class="line"><span class="attr">        server-addr:</span> <span class="attr">localhost:8848</span></span><br><span class="line"><span class="attr">    sentinel:</span></span><br><span class="line"><span class="attr">      transport:</span></span><br><span class="line"><span class="attr">        dashboard:</span> <span class="attr">localhost:12345</span></span><br><span class="line">        <span class="comment"># 默认8719，如果被占用会自动从8719开始+1扫描</span></span><br><span class="line"><span class="attr">        port:</span> <span class="number">8719</span></span><br><span class="line">      <span class="comment"># 配置datasource</span></span><br><span class="line"><span class="attr">      datasource:</span></span><br><span class="line">        <span class="comment"># 数据源名</span></span><br><span class="line"><span class="attr">        ds1:</span></span><br><span class="line">          <span class="comment"># 使用nacos</span></span><br><span class="line"><span class="attr">          nacos:</span></span><br><span class="line"><span class="attr">            server-addr:</span> <span class="attr">localhost:8848</span></span><br><span class="line"><span class="attr">            dataId:</span> <span class="string">cloudalibaba-sentinel-service</span></span><br><span class="line"><span class="attr">            groupId:</span> <span class="string">DEFAULT_GROUP</span></span><br><span class="line"><span class="attr">            data-type:</span> <span class="string">json</span></span><br><span class="line"><span class="attr">            rule-type:</span> <span class="string">flow</span></span><br></pre></td></tr></table></figure><p>可以看到，可以使用多种数据源来持久化</p><p><img src="../../../%25E6%25A1%258C%25E9%259D%25A2/SpringCloud/image-20200524175848893.png" alt="image-20200524175848893"></p></li><li><p>添加 Nacos 配置，在上一步设定的配置信息中：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"resource"</span>: <span class="string">"bbyResource"</span>,</span><br><span class="line">        <span class="attr">"limitApp"</span>: <span class="string">"default"</span>,</span><br><span class="line">        <span class="attr">"grade"</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">"count"</span>: <span class="number">5</span>,</span><br><span class="line">        <span class="attr">"strategy"</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">"controlBehavior"</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">"clusterMode"</span>: <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure></li><li><p>这样重启会后也可以持久化</p></li></ol><blockquote><p>然而控制台添加的规则还是在内存里面，不会从存储到 nacos 中</p><p>当新建配置时，会发送一个 post 请求：</p><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200605155918.png" alt></p><p>直接复制请求的 json 到 nacos 中就可以（nacos 中的配置是一个数组，将 json 对象添加到数组中）</p><p>如果想在控制台修改的数据自动同步到 Nacos 中，可以参考：<a href="https://www.sonake.com/2019/12/16/Sentinel-Nacos实现规则持久化/#第一步-Sentinel客户端配置" target="_blank" rel="noopener">Sentinel-Nacos实现规则持久化</a></p><p>参考：</p><ul><li><a href="https://github.com/alibaba/Sentinel/wiki/如何使用#查询更改规则" target="_blank" rel="noopener">查询更改规则</a></li><li><a href="[https://github.com/alibaba/Sentinel/wiki/Sentinel-%E6%8E%A7%E5%88%B6%E5%8F%B0%EF%BC%88%E9%9B%86%E7%BE%A4%E6%B5%81%E6%8E%A7%E7%AE%A1%E7%90%86%EF%BC%89#%E8%A7%84%E5%88%99%E9%85%8D%E7%BD%AE](https://github.com/alibaba/Sentinel/wiki/Sentinel-控制台（集群流控管理）#规则配置">Sentinel-控制台（集群流控管理）#规则配置</a>)</li></ul></blockquote><h2 id="Seata"><a href="#Seata" class="headerlink" title="Seata"></a>Seata</h2><h3 id="分布式事务"><a href="#分布式事务" class="headerlink" title="分布式事务"></a>分布式事务</h3><h4 id="概述-7"><a href="#概述-7" class="headerlink" title="概述"></a>概述</h4><p>单体应用被拆分成微服务，每个服务内部的数据一致性由本地事务保证，但是全局的数据一致性没办法保证。</p><p>一次业务操作需要跨多个数据源或多个系统进行远程调用，就会产生分布式事务问题。</p><blockquote><p><kbd><a href="https://cloud.tencent.com/developer/article/1446247" target="_blank" rel="noopener">分布式事务</a></kbd></p><p><strong>2.分布式事务产生原因</strong></p><p>当架构由单体向多服务演进时，整个系统的可靠性变得难以控制，在单体服务中，一个请求的整个周期，从请求到响应结果，都是在一台服务器上，本地事务就可以保证一组数据操作的一致性。</p><p>在微服务中，从请求到响应，之间可能跨越多台服务器，多个数据库，如下图，假设有个金融系统，拆分为了多个微服务，每个微服务有自己的数据库，我们现在发起借款这个操作，需要用到以下几个微服务：</p><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200525100417.png" alt></p><p>这个借款操作，可以抽象概括为以下几个步骤：</p><p>1.用户发起借款，调用借款服务的借款接口；</p><p>2.借款同时，在授信服务里 减少授信额度；</p><p>3.借款同时，在资金服务里 增加账户余额；</p><p>4.借款同时，在日志服务里 增加流水记录；</p><p>……</p><p>这里只是假设，实际金融项目中的借款这个动作发生的事情远比上图复杂。</p><p>由于每个服务都是单独部署的，在理想状态下，上述的操作，可以顺利得以执行。</p><p>如果中间有服务发生故障了呢？</p><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200525100438.png" alt></p><p>假设一个常见的场景，资金服务由于没有合理使用线程池和连接池，现在内存爆掉，无法正常处理请求，那么，这个链路成为了如下的样子：</p><p>1.用户发起借款，调用借款服务的借款接口；</p><p>2.借款同时，在授信服务里 减少授信额度；</p><p>3.借款同时，在资金服务里 增加账户余额；x</p><p>4.借款同时，在日志服务里 增加流水记录；</p><p>……</p><p>此时，由于是在多个服务中，本地的Transaction已经无法应对这个情况了，现在系列操作导致了上述的情况，用户的授信额度减少了，流水也记录了，但是用户没有收到钱。</p></blockquote><blockquote><p><kbd>SOURCE</kbd> <a href="https://juejin.im/post/5b5a0bf9f265da0f6523913b#heading-9" target="_blank" rel="noopener">再有人问你分布式事务，把这篇扔给他</a></p></blockquote><h4 id="分布式事务过程（一ID-三组件）"><a href="#分布式事务过程（一ID-三组件）" class="headerlink" title="分布式事务过程（一ID + 三组件）"></a>分布式事务过程（一ID + 三组件）</h4><ul><li><p><strong><em>Transaction ID XID</em></strong> 全局唯一的事务 ID</p></li><li><p>三组件</p><ul><li><p><strong><em>Transaction Coordinator(TC)</em></strong></p><p>事务协调器，维护全局事务的运行状态，负责协调并驱动全局事务的提交或混滚；</p></li><li><p><strong><em>Transaction Manager(TM)</em></strong></p><p>控制全局事务的边界，负责开启一个全局事务，并最终发起全局提交或全局回滚的决议；</p></li><li><p><strong><em>Resource Manager(RM)</em></strong></p><p>控制分支事务，负责分支注册、状态汇报、并接收事务协调器的指令，驱动分支（本地）事务的提交和回滚</p></li></ul></li></ul><p>一个典型的分布式事务过程：</p><ol><li>TM 向 TC 申请开启一个全局事务，全局事务创建成功并生成一个全局唯一的 XID。</li><li>XID 在微服务调用链路的上下文中传播。</li><li>RM 向 TC 注册分支事务，将其纳入 XID 对应全局事务的管辖。</li><li>TM 向 TC 发起针对 XID 的全局提交或回滚决议。</li><li>TC 调度 XID 下管辖的全部分支事务完成提交或回滚请求。</li></ol><p><img src="https://gitee.com/PhoenixXc/FigureBed/raw/picgo/img/20200525102501.png" alt></p><h3 id="Seata-1"><a href="#Seata-1" class="headerlink" title="Seata"></a>Seata</h3><h4 id="概述-8"><a href="#概述-8" class="headerlink" title="概述"></a>概述</h4><p>Seata 是一款开源的分布式事务解决方案，致力于在微服务架构下提供高性能和简单易用的分布式事务服务。</p><p>官网：<a href="http://seata.io/zh-cn/" target="_blank" rel="noopener">http://seata.io/zh-cn/</a></p><h4 id="下载安装"><a href="#下载安装" class="headerlink" title="下载安装"></a>下载安装</h4><ol><li><p>下载相应的版本：<a href="http://seata.io/zh-cn/blog/download.html" target="_blank" rel="noopener">http://seata.io/zh-cn/blog/download.html</a></p></li><li><p>新建数据库，导入 sql</p><p>sql 地址：<a href="https://github.com/seata/seata/blob/1.2.0/script/server/db/mysql.sql" target="_blank" rel="noopener">https://github.com/seata/seata/blob/1.2.0/script/server/db/mysql.sql</a></p></li><li><p>修改 file.conf</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">## transaction log store, only used in seata-server</span><br><span class="line">store &#123;</span><br><span class="line">  ## store mode: file、db</span><br><span class="line">  # 设置为db</span><br><span class="line">  mode = &quot;db&quot;</span><br><span class="line"></span><br><span class="line">  ## file store property</span><br><span class="line">  file &#123;</span><br><span class="line">  	## ....</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ## database store property</span><br><span class="line">  db &#123;</span><br><span class="line">    ## the implement of javax.sql.DataSource, such as DruidDataSource(druid)/BasicDataSource(dbcp) etc.</span><br><span class="line">    datasource = &quot;druid&quot;</span><br><span class="line">    ## mysql/oracle/postgresql/h2/oceanbase etc.</span><br><span class="line">    dbType = &quot;mysql&quot;</span><br><span class="line">    driverClassName = &quot;com.mysql.jdbc.Driver&quot;</span><br><span class="line">    # 数据库配置</span><br><span class="line">    url = &quot;jdbc:mysql://127.0.0.1:3306/seata&quot;</span><br><span class="line">    user = &quot;root&quot;</span><br><span class="line">    password = &quot;mysqlpass&quot;</span><br><span class="line">    minConn = 5</span><br><span class="line">    maxConn = 30</span><br><span class="line">    globalTable = &quot;global_table&quot;</span><br><span class="line">    branchTable = &quot;branch_table&quot;</span><br><span class="line">    lockTable = &quot;lock_table&quot;</span><br><span class="line">    queryLimit = 100</span><br><span class="line">    maxWait = 5000</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>修改 register.conf</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">registry &#123;</span><br><span class="line">  # file 、nacos 、eureka、redis、zk、consul、etcd3、sofa</span><br><span class="line">  type = &quot;nacos&quot;</span><br><span class="line"></span><br><span class="line">  nacos &#123;</span><br><span class="line">    application = &quot;seata-server&quot;</span><br><span class="line">    serverAddr = &quot;localhost:8848&quot;</span><br><span class="line">    namespace = &quot;&quot;</span><br><span class="line">    cluster = &quot;default&quot;</span><br><span class="line">    username = &quot;&quot;</span><br><span class="line">    password = &quot;&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  ## ....</span><br></pre></td></tr></table></figure></li><li><p>启动 Nacos</p></li><li><p>运行脚本：</p><p>| -h | –host | 指定在注册中心注册的 IP | 不指定时获取当前的 IP，外部访问部署在云环境和容器中的 server 建议指定 |<br>| —- | ———— | ————————– | ———————————————————— |<br>| -p | –port | 指定 server 启动的端口 | 默认为 8091 |<br>| -m | –storeMode | 事务日志存储方式 | 支持<code>file</code>和<code>db</code>，默认为 <code>file</code> |<br>| -n | –serverNode | 用于指定seata-server节点ID | ,如 <code>1</code>,<code>2</code>,<code>3</code>…, 默认为 <code>1</code> |<br>| -e | –seataEnv | 指定 seata-server 运行环境 | 如 <code>dev</code>, <code>test</code> 等, 服务启动时会使用 <code>registry-dev.conf</code> 这样的配置 |</p><p>如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sh ./bin/seata-server.sh -p 8091 -h 127.0.0.1</span><br></pre></td></tr></table></figure></li></ol><h3 id="使用-2"><a href="#使用-2" class="headerlink" title="使用"></a>使用</h3><blockquote><p>用例来自官网文档</p></blockquote><p>用户购买商品的业务逻辑。整个业务逻辑由3个微服务提供支持：</p><ul><li>仓储服务：对给定的商品扣除仓储数量。</li><li>订单服务：根据采购需求创建订单。</li><li>帐户服务：从用户帐户中扣除余额。</li></ul><h4 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h4><p>官网 WIKI 莫得配置说明就很难受 emmm</p><p>参考：</p><ul><li><a href="https://seata.io/zh-cn/blog/seata-quick-start.html" target="_blank" rel="noopener">Seata极简入门</a></li><li><a href="https://www.jianshu.com/p/c517d488ab67" target="_blank" rel="noopener">Seata 配置文件说明</a></li></ul><h4 id="架构图"><a href="#架构图" class="headerlink" title="架构图"></a>架构图</h4><p><img src="http://seata.io/img/architecture.png" alt="Architecture"></p><h4 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h4><ol><li><p>在 MySQL 中分别创建三个数据库</p></li><li><p>每个数据库中创建 undo_log 回滚日志表</p><p>在业务相关的数据库中添加 undo_log 表，用于保存需要回滚的数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`undo_log`</span></span><br><span class="line">(</span><br><span class="line">    <span class="string">`id`</span>            <span class="built_in">BIGINT</span>(<span class="number">20</span>)   <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">    <span class="string">`branch_id`</span>     <span class="built_in">BIGINT</span>(<span class="number">20</span>)   <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="string">`xid`</span>           <span class="built_in">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="string">`context`</span>       <span class="built_in">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="string">`rollback_info`</span> LONGBLOB     <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="string">`log_status`</span>    <span class="built_in">INT</span>(<span class="number">11</span>)      <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="string">`log_created`</span>   DATETIME     <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="string">`log_modified`</span>  DATETIME     <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="string">`ext`</span>           <span class="built_in">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</span><br><span class="line">    <span class="keyword">UNIQUE</span> <span class="keyword">KEY</span> <span class="string">`ux_undo_log`</span> (<span class="string">`xid`</span>, <span class="string">`branch_id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span></span><br><span class="line">  AUTO_INCREMENT = <span class="number">1</span></span><br><span class="line">  <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span> = utf8</span><br></pre></td></tr></table></figure><blockquote><p>地址：<a href="https://github.com/seata/seata/blob/develop/script/client/at/db/mysql.sql" target="_blank" rel="noopener">https://github.com/seata/seata/blob/develop/script/client/at/db/mysql.sql</a></p></blockquote></li><li><p>引入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Seata--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-seata<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>seata-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.seata<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- seata 1.2 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.seata<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>seata-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>==导入Maven包时，一定要注意，seato-all的版本和本地服务的版本是否一致！！！不然即使配置OK，也可能会出现运行错误！！==</p><p><code>exclude</code> 排除包之后，引入与服务端版本匹配的 jar 包</p></blockquote></li><li><p>添加Seata 配置文件</p><ul><li><p><strong><em>registry.conf</em></strong></p><p>该配置用于指定 TC 的注册中心和配置文件，默认都是 <em>file</em>; <u>如果使用其他的注册中心，要求 Seata-Server 也注册到该配置中心上</u></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"># 注册中心(要与服务端注册中心相同)</span><br><span class="line">registry &#123;</span><br><span class="line">  # file 、nacos 、eureka、redis、zk、consul、etcd3、sofa</span><br><span class="line">  type = &quot;file&quot;</span><br><span class="line"></span><br><span class="line">  nacos &#123;</span><br><span class="line">    serverAddr = &quot;localhost&quot;</span><br><span class="line">    namespace = &quot;public&quot;</span><br><span class="line">    cluster = &quot;default&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  eureka &#123;</span><br><span class="line">    serviceUrl = &quot;http://localhost:8761/eureka&quot;</span><br><span class="line">    application = &quot;default&quot;</span><br><span class="line">    weight = &quot;1&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  redis &#123;</span><br><span class="line">    serverAddr = &quot;localhost:6379&quot;</span><br><span class="line">    db = &quot;0&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  zk &#123;</span><br><span class="line">    cluster = &quot;default&quot;</span><br><span class="line">    serverAddr = &quot;127.0.0.1:2181&quot;</span><br><span class="line">    session.timeout = 6000</span><br><span class="line">    connect.timeout = 2000</span><br><span class="line">  &#125;</span><br><span class="line">  consul &#123;</span><br><span class="line">    cluster = &quot;default&quot;</span><br><span class="line">    serverAddr = &quot;127.0.0.1:8500&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  etcd3 &#123;</span><br><span class="line">    cluster = &quot;default&quot;</span><br><span class="line">    serverAddr = &quot;http://localhost:2379&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  sofa &#123;</span><br><span class="line">    serverAddr = &quot;127.0.0.1:9603&quot;</span><br><span class="line">    application = &quot;default&quot;</span><br><span class="line">    region = &quot;DEFAULT_ZONE&quot;</span><br><span class="line">    datacenter = &quot;DefaultDataCenter&quot;</span><br><span class="line">    cluster = &quot;default&quot;</span><br><span class="line">    group = &quot;SEATA_GROUP&quot;</span><br><span class="line">    addressWaitTime = &quot;3000&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  file &#123;</span><br><span class="line">    name = &quot;file.conf&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 配置中心，只有为&apos;file&apos;时，file.conf才会生效，需要配置</span><br><span class="line">config &#123;</span><br><span class="line">  # file、nacos 、apollo、zk、consul、etcd3</span><br><span class="line">  type = &quot;file&quot;</span><br><span class="line"></span><br><span class="line">  nacos &#123;</span><br><span class="line">    serverAddr = &quot;localhost&quot;</span><br><span class="line">    namespace = &quot;public&quot;</span><br><span class="line">    cluster = &quot;default&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  consul &#123;</span><br><span class="line">    serverAddr = &quot;127.0.0.1:8500&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  apollo &#123;</span><br><span class="line">    app.id = &quot;seata-server&quot;</span><br><span class="line">    apollo.meta = &quot;http://192.168.1.204:8801&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  zk &#123;</span><br><span class="line">    serverAddr = &quot;127.0.0.1:2181&quot;</span><br><span class="line">    session.timeout = 6000</span><br><span class="line">    connect.timeout = 2000</span><br><span class="line">  &#125;</span><br><span class="line">  etcd3 &#123;</span><br><span class="line">    serverAddr = &quot;http://localhost:2379&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  file &#123;</span><br><span class="line">    name = &quot;file.conf&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul></li></ol><ul><li><p><strong><em>file.conf</em></strong></p><p>该配置用于指定TC的相关属性；如果使用注册中心也可以将配置添加到配置中心</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line">transport &#123;</span><br><span class="line">  # tcp udt unix-domain-socket</span><br><span class="line">  type = &quot;TCP&quot;</span><br><span class="line">  #NIO NATIVE</span><br><span class="line">  server = &quot;NIO&quot;</span><br><span class="line">  #enable heartbeat</span><br><span class="line">  heartbeat = true</span><br><span class="line">  #thread factory for netty</span><br><span class="line">  thread-factory &#123;</span><br><span class="line">    boss-thread-prefix = &quot;NettyBoss&quot;</span><br><span class="line">    worker-thread-prefix = &quot;NettyServerNIOWorker&quot;</span><br><span class="line">    server-executor-thread-prefix = &quot;NettyServerBizHandler&quot;</span><br><span class="line">    share-boss-worker = false</span><br><span class="line">    client-selector-thread-prefix = &quot;NettyClientSelector&quot;</span><br><span class="line">    client-selector-thread-size = 1</span><br><span class="line">    client-worker-thread-prefix = &quot;NettyClientWorkerThread&quot;</span><br><span class="line">    # netty boss thread size,will not be used for UDT</span><br><span class="line">    boss-thread-size = 1</span><br><span class="line">    #auto default pin or 8</span><br><span class="line">    worker-thread-size = 8</span><br><span class="line">  &#125;</span><br><span class="line">  shutdown &#123;</span><br><span class="line">    # when destroy server, wait seconds</span><br><span class="line">    wait = 3</span><br><span class="line">  &#125;</span><br><span class="line">  serialization = &quot;seata&quot;</span><br><span class="line">  compressor = &quot;none&quot;</span><br><span class="line">&#125;</span><br><span class="line">service &#123;</span><br><span class="line">  #vgroup-&gt;rgroup</span><br><span class="line">  vgroup_mapping.my_test_tx_group = &quot;default&quot;</span><br><span class="line">  #only support single node</span><br><span class="line">  default.grouplist = &quot;127.0.0.1:8091&quot;</span><br><span class="line">  #degrade current not support</span><br><span class="line">  enableDegrade = false</span><br><span class="line">  #disable</span><br><span class="line">  disable = false</span><br><span class="line">  #unit ms,s,m,h,d represents milliseconds, seconds, minutes, hours, days, default permanent</span><br><span class="line">  max.commit.retry.timeout = &quot;-1&quot;</span><br><span class="line">  max.rollback.retry.timeout = &quot;-1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">client &#123;</span><br><span class="line">  async.commit.buffer.limit = 10000</span><br><span class="line">  lock &#123;</span><br><span class="line">    retry.internal = 10</span><br><span class="line">    retry.times = 30</span><br><span class="line">  &#125;</span><br><span class="line">  report.retry.count = 5</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">## transaction log store</span><br><span class="line">store &#123;</span><br><span class="line">  ## store mode: file、db</span><br><span class="line">  mode = &quot;file&quot;</span><br><span class="line"></span><br><span class="line">  ## file store</span><br><span class="line">  file &#123;</span><br><span class="line">    dir = &quot;sessionStore&quot;</span><br><span class="line"></span><br><span class="line">    # branch session size , if exceeded first try compress lockkey, still exceeded throws exceptions</span><br><span class="line">    max-branch-session-size = 16384</span><br><span class="line">    # globe session size , if exceeded throws exceptions</span><br><span class="line">    max-global-session-size = 512</span><br><span class="line">    # file buffer size , if exceeded allocate new buffer</span><br><span class="line">    file-write-buffer-cache-size = 16384</span><br><span class="line">    # when recover batch read size</span><br><span class="line">    session.reload.read_size = 100</span><br><span class="line">    # async, sync</span><br><span class="line">    flush-disk-mode = async</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ## database store</span><br><span class="line">  db &#123;</span><br><span class="line">    ## the implement of javax.sql.DataSource, such as DruidDataSource(druid)/BasicDataSource(dbcp) etc.</span><br><span class="line">    datasource = &quot;dbcp&quot;</span><br><span class="line">    ## mysql/oracle/h2/oceanbase etc.</span><br><span class="line">    db-type = &quot;mysql&quot;</span><br><span class="line">    url = &quot;jdbc:mysql://127.0.0.1:3306/seata&quot;</span><br><span class="line">    user = &quot;mysql&quot;</span><br><span class="line">    password = &quot;mysql&quot;</span><br><span class="line">    min-conn = 1</span><br><span class="line">    max-conn = 3</span><br><span class="line">    global.table = &quot;global_table&quot;</span><br><span class="line">    branch.table = &quot;branch_table&quot;</span><br><span class="line">    lock-table = &quot;lock_table&quot;</span><br><span class="line">    query-limit = 100</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">lock &#123;</span><br><span class="line">  ## the lock store mode: local、remote</span><br><span class="line">  mode = &quot;remote&quot;</span><br><span class="line"></span><br><span class="line">  local &#123;</span><br><span class="line">    ## store locks in user&apos;s database</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  remote &#123;</span><br><span class="line">    ## store locks in the seata&apos;s server</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">recovery &#123;</span><br><span class="line">  committing-retry-delay = 30</span><br><span class="line">  asyn-committing-retry-delay = 30</span><br><span class="line">  rollbacking-retry-delay = 30</span><br><span class="line">  timeout-retry-delay = 30</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">transaction &#123;</span><br><span class="line">  undo.data.validation = true</span><br><span class="line">  undo.log.serialization = &quot;jackson&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">## metrics settings</span><br><span class="line">metrics &#123;</span><br><span class="line">  enabled = false</span><br><span class="line">  registry-type = &quot;compact&quot;</span><br><span class="line">  # multi exporters use comma divided</span><br><span class="line">  exporter-list = &quot;prometheus&quot;</span><br><span class="line">  exporter-prometheus-port = 9898</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><a href="http://seata.io/zh-cn/docs/user/configurations.html" target="_blank" rel="noopener">参数配置</a></p></blockquote><p>需要注意的是 <code>service.vgroup_mapping</code> 这个配置，在 Spring Cloud 中默认是<code>${spring.application.name}-fescar-service-group</code>，可以通过指定<code>application.properties</code>的 <code>spring.cloud.alibaba.seata.tx-service-group</code>这个属性覆盖，但是必须要和 <code>file.conf</code>中的一致，否则会提示 <code>no available server to connect</code>。（jar包与服务端版本号不一致有时也会出现这个问题）</p></li></ul><ol start="5"><li><p>注入数据源</p><p>Seata 通过代理数据源的方式实现分支事务；MyBatis 和 JPA 都需要注入 <code>io.seata.rm.datasource.DataSourceProxy</code>, 不同的是，MyBatis 还需要额外注入 <code>org.apache.ibatis.session.SqlSessionFactory</code></p><ul><li><p><strong><em>Mybatis</em></strong></p><blockquote><p>需要引入依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">&gt;  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">&gt;  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">&gt; <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">&gt; <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">&gt;  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">&gt;  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">&gt;  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">&gt; <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">&gt; <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">&gt;  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">&gt;  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">&gt; <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">&gt; <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">&gt;  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">&gt;  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">&gt; <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></blockquote><blockquote><p>官网示例引入了 <em>Druid</em></p></blockquote><p>配置文件：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSourceProxyConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"spring.datasource"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DruidDataSource();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSourceProxy <span class="title">dataSourceProxy</span><span class="params">(DataSource dataSource)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DataSourceProxy(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SqlSessionFactory <span class="title">sqlSessionFactoryBean</span><span class="params">(DataSourceProxy dataSourceProxy)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        SqlSessionFactoryBean sqlSessionFactoryBean = <span class="keyword">new</span> SqlSessionFactoryBean();</span><br><span class="line">        sqlSessionFactoryBean.setDataSource(dataSourceProxy);</span><br><span class="line">        <span class="keyword">return</span> sqlSessionFactoryBean.getObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>这种方式由于手动创建了 <code>SqlSessionFactory</code>，所以 <em>application.yml/properties</em> 中的配置需要手动注入并设置才会生效</p></blockquote><p>启动类也要添加注解：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// import org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span>(exclude = DataSourceAutoConfiguration.class)</span><br></pre></td></tr></table></figure></li></ul></li><li><p>启动必要的服务：包括 Seata-server 以及依赖的注册或配置中心</p></li><li><p>使用 <code>@GlobalTransactional</code> 开启事务</p><p>在业务的发起方的方法上使用 <code>@GlobalTransactional</code> 开启全局事务，Seata 会将事务的 xid 通过拦截器添加到调用其他服务的请求中，实现分布式事务</p></li></ol><blockquote><p>参考：</p><ul><li><p><a href="https://www.cnblogs.com/victorbu/p/12738556.html" target="_blank" rel="noopener">https://www.cnblogs.com/victorbu/p/12738556.html</a></p></li><li><p><a href="https://blog.funkye.icu/2020/02/19/seata-quick/" target="_blank" rel="noopener">https://blog.funkye.icu/2020/02/19/seata-quick/</a></p></li><li><a href="http://seata.io/zh-cn/docs/user/configurations.html" target="_blank" rel="noopener">参数配置</a></li></ul><p><em>2.2.0.RELEASE+</em> 不需要手动配置数据源代理，直接创建一个</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="meta">@Bean</span></span><br><span class="line">&gt; <span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"spring.datasource"</span>)</span><br><span class="line">&gt; <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">&gt;     <span class="keyword">return</span> <span class="keyword">new</span> DruidDataSource();</span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></blockquote><blockquote><p>即可，如果不是 2.2.0 及以上但 Seata 版本高于 1.1.0，可以参考：（貌似0.8以上的支持参数配置，1.1.0 使用注解代替）</p><blockquote><p>seata1.1.0版本新加入以下注解,用于开启数据源自动代理功能 <code>@EnableAutoDataSourceProxy</code></p><ol><li><p>对于使用seata-spring-boot-starter的方式，默认已开启数据源自动代理,如需关闭，请配置seata.enableAutoDataSourceProxy=false，该项配置默认为true。 如需切换代理实现方式，请通过seata.useJdkProxy=false进行配置,默认为false，采用CGLIB作为数据源自动代理的实现方式。</p></li><li><p>对于使用seata-all的方式，请使用@EnableAutoDataSourceProxy来显式开启数据源自动代理功能。如有需要，可通过该注解的useJdkProxy属性进行代理实现方式 的切换。默认为false,采用CGLIB作为数据源自动代理的实现方式。</p></li></ol></blockquote></blockquote></div><footer class="post-footer"><div class="post-tags"><a href="/tags/springcloud/" rel="tag"># springcloud</a> <a href="/tags/微服务/" rel="tag"># 微服务</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/posts/e7896c93/" rel="next" title="源码分析之 —— ArrayList"><i class="fa fa-chevron-left"></i> 源码分析之 —— ArrayList</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/posts/6940af88/" rel="prev" title="CAP理论">CAP理论 <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"></div></div></div><div class="comments" id="comments"></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="PhoenixBM"><p class="site-author-name" itemprop="name">PhoenixBM</p><p class="site-description motion-element" itemprop="description">pxBlog</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">23</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">5</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">12</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/PhoenixXC" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a></span></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#准备"><span class="nav-number">1.</span> <span class="nav-text">准备</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#版本对应关系"><span class="nav-number">1.0.1.</span> <span class="nav-text">版本对应关系</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Cloud-停更"><span class="nav-number">1.0.2.</span> <span class="nav-text">Cloud 停更</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#资料"><span class="nav-number">1.0.3.</span> <span class="nav-text">资料</span></a></li></ol></li></ol><li class="nav-item nav-level-2"><a class="nav-link" href="#架构搭建"><span class="nav-number">2.</span> <span class="nav-text">架构搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#微服务模块的创建"><span class="nav-number">2.0.1.</span> <span class="nav-text">微服务模块的创建</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#热部署的开启"><span class="nav-number">2.0.2.</span> <span class="nav-text">热部署的开启</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#服务治理"><span class="nav-number">3.</span> <span class="nav-text">服务治理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Eureka"><span class="nav-number">3.1.</span> <span class="nav-text">Eureka</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#集群原理"><span class="nav-number">3.1.1.</span> <span class="nav-text">集群原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#自我保护机制"><span class="nav-number">3.1.2.</span> <span class="nav-text">自我保护机制</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Zookeeper"><span class="nav-number">3.2.</span> <span class="nav-text">Zookeeper</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Consul"><span class="nav-number">3.3.</span> <span class="nav-text">Consul</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#作用"><span class="nav-number">3.3.1.</span> <span class="nav-text">作用</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#三个注册中心异同"><span class="nav-number">3.4.</span> <span class="nav-text">三个注册中心异同</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#负载均衡"><span class="nav-number">4.</span> <span class="nav-text">负载均衡</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#关于"><span class="nav-number">4.1.</span> <span class="nav-text">关于</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#什么是负载均衡"><span class="nav-number">4.1.1.</span> <span class="nav-text">什么是负载均衡</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#本地负载均衡客户端-vs-Nginx-服务端负载均衡"><span class="nav-number">4.1.2.</span> <span class="nav-text">本地负载均衡客户端 vs Nginx 服务端负载均衡</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#集中式-vs-进程内"><span class="nav-number">4.1.3.</span> <span class="nav-text">集中式 vs 进程内</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Ribbon"><span class="nav-number">4.2.</span> <span class="nav-text">Ribbon</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#IRule"><span class="nav-number">4.2.1.</span> <span class="nav-text">IRule</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#替换负载均衡算法"><span class="nav-number">4.2.2.</span> <span class="nav-text">替换负载均衡算法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#负载均衡算法原理"><span class="nav-number">4.2.3.</span> <span class="nav-text">负载均衡算法原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#手写负载均衡算法"><span class="nav-number">4.2.4.</span> <span class="nav-text">手写负载均衡算法</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#服务调用"><span class="nav-number">5.</span> <span class="nav-text">服务调用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#OpenFegin"><span class="nav-number">5.1.</span> <span class="nav-text">OpenFegin</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#超时设置"><span class="nav-number">5.1.1.</span> <span class="nav-text">超时设置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#日志"><span class="nav-number">5.1.2.</span> <span class="nav-text">日志</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#服务降级"><span class="nav-number">6.</span> <span class="nav-text">服务降级</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#服务雪崩"><span class="nav-number">6.0.1.</span> <span class="nav-text">服务雪崩</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#服务降级（fallback）"><span class="nav-number">6.0.2.</span> <span class="nav-text">服务降级（fallback）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#服务熔断（break）"><span class="nav-number">6.0.3.</span> <span class="nav-text">服务熔断（break）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#服务限流（flowlimit）"><span class="nav-number">6.0.4.</span> <span class="nav-text">服务限流（flowlimit）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hystrix"><span class="nav-number">6.1.</span> <span class="nav-text">Hystrix</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#做用"><span class="nav-number">6.1.1.</span> <span class="nav-text">做用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#服务降级-Pratice"><span class="nav-number">6.1.2.</span> <span class="nav-text">服务降级 Pratice</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#服务熔断"><span class="nav-number">6.1.3.</span> <span class="nav-text">服务熔断</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Hystrix-Dashboard"><span class="nav-number">6.1.4.</span> <span class="nav-text">Hystrix Dashboard</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#服务网关"><span class="nav-number">7.</span> <span class="nav-text">服务网关</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Gateway"><span class="nav-number">7.1.</span> <span class="nav-text">Gateway</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#作用-1"><span class="nav-number">7.1.1.</span> <span class="nav-text">作用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#优势"><span class="nav-number">7.1.2.</span> <span class="nav-text">优势</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Zuul-模型"><span class="nav-number">7.1.3.</span> <span class="nav-text">Zuul 模型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Gateway-1"><span class="nav-number">7.1.4.</span> <span class="nav-text">Gateway</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#路由-Route"><span class="nav-number">7.1.5.</span> <span class="nav-text">路由(Route)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#断言-Predicate"><span class="nav-number">7.1.6.</span> <span class="nav-text">断言(Predicate)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#过滤-Filter"><span class="nav-number">7.1.7.</span> <span class="nav-text">过滤(Filter)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Gateway-工作流程"><span class="nav-number">7.1.8.</span> <span class="nav-text">Gateway 工作流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置"><span class="nav-number">7.1.9.</span> <span class="nav-text">配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Predicate"><span class="nav-number">7.1.10.</span> <span class="nav-text">Predicate</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Filter"><span class="nav-number">7.1.11.</span> <span class="nav-text">Filter</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#服务配置"><span class="nav-number">8.</span> <span class="nav-text">服务配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Config"><span class="nav-number">8.1.</span> <span class="nav-text">Config</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#服务端配置"><span class="nav-number">8.1.1.</span> <span class="nav-text">服务端配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#客户端配置"><span class="nav-number">8.1.2.</span> <span class="nav-text">客户端配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#boostrap-yml"><span class="nav-number">8.1.3.</span> <span class="nav-text">boostrap.yml</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置刷新"><span class="nav-number">8.1.4.</span> <span class="nav-text">配置刷新</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#消息总线"><span class="nav-number">9.</span> <span class="nav-text">消息总线</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Bus"><span class="nav-number">9.1.</span> <span class="nav-text">Bus</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Config自动刷新步骤"><span class="nav-number">9.1.1.</span> <span class="nav-text">Config自动刷新步骤</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#定点通知"><span class="nav-number">9.1.2.</span> <span class="nav-text">定点通知</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Cloud-Stream"><span class="nav-number">10.</span> <span class="nav-text">Cloud Stream</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#概述"><span class="nav-number">10.1.</span> <span class="nav-text">概述</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#是什么"><span class="nav-number">10.1.1.</span> <span class="nav-text">是什么</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#设计思想"><span class="nav-number">10.2.</span> <span class="nav-text">设计思想</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#标准MQ"><span class="nav-number">10.2.1.</span> <span class="nav-text">标准MQ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#为什么用Cloud-Stream"><span class="nav-number">10.2.2.</span> <span class="nav-text">为什么用Cloud Stream</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Binder"><span class="nav-number">10.2.3.</span> <span class="nav-text">Binder</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#通信方式"><span class="nav-number">10.2.4.</span> <span class="nav-text">通信方式</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用方法"><span class="nav-number">10.3.</span> <span class="nav-text">使用方法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#组成"><span class="nav-number">10.3.1.</span> <span class="nav-text">组成</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#常用注解"><span class="nav-number">10.3.2.</span> <span class="nav-text">常用注解</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#USE"><span class="nav-number">10.3.3.</span> <span class="nav-text">USE</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#分组消费和持久化"><span class="nav-number">10.3.4.</span> <span class="nav-text">分组消费和持久化</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#链路追踪"><span class="nav-number">11.</span> <span class="nav-text">链路追踪</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Sleuth-amp-Zipkin"><span class="nav-number">11.1.</span> <span class="nav-text">Sleuth &amp; Zipkin</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Zipkin"><span class="nav-number">11.1.1.</span> <span class="nav-text">Zipkin</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用"><span class="nav-number">11.1.2.</span> <span class="nav-text">使用</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nacos"><span class="nav-number">12.</span> <span class="nav-text">Nacos</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#概述-1"><span class="nav-number">12.1.</span> <span class="nav-text">概述</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#是什么-1"><span class="nav-number">12.1.1.</span> <span class="nav-text">是什么</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#作用-2"><span class="nav-number">12.1.2.</span> <span class="nav-text">作用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#注册中心比较"><span class="nav-number">12.1.3.</span> <span class="nav-text">注册中心比较</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#安装运行"><span class="nav-number">12.1.4.</span> <span class="nav-text">安装运行</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#服务注册-amp-发现和配置管理"><span class="nav-number">12.1.5.</span> <span class="nav-text">服务注册&amp;发现和配置管理</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#服务注册"><span class="nav-number">12.2.</span> <span class="nav-text">服务注册</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#服务端"><span class="nav-number">12.2.1.</span> <span class="nav-text">服务端</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#客户端"><span class="nav-number">12.2.2.</span> <span class="nav-text">客户端</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#基础配置"><span class="nav-number">12.3.</span> <span class="nav-text">基础配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#分类配置"><span class="nav-number">12.4.</span> <span class="nav-text">分类配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#DataID"><span class="nav-number">12.4.1.</span> <span class="nav-text">DataID</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Group"><span class="nav-number">12.4.2.</span> <span class="nav-text">Group</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Namespace"><span class="nav-number">12.4.3.</span> <span class="nav-text">Namespace</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#集群"><span class="nav-number">12.5.</span> <span class="nav-text">集群</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#集群模式部署"><span class="nav-number">12.5.1.</span> <span class="nav-text">集群模式部署</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#集群部署架构图"><span class="nav-number">12.5.2.</span> <span class="nav-text">集群部署架构图</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#部署"><span class="nav-number">12.5.3.</span> <span class="nav-text">部署</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Sentinel"><span class="nav-number">13.</span> <span class="nav-text">Sentinel</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#概述-2"><span class="nav-number">13.1.</span> <span class="nav-text">概述</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#组成-1"><span class="nav-number">13.1.1.</span> <span class="nav-text">组成</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#安装"><span class="nav-number">13.1.2.</span> <span class="nav-text">安装</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用-1"><span class="nav-number">13.2.</span> <span class="nav-text">使用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#服务端-1"><span class="nav-number">13.2.1.</span> <span class="nav-text">服务端</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#客户端-1"><span class="nav-number">13.2.2.</span> <span class="nav-text">客户端</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#流量控制（流控，flow-control）"><span class="nav-number">13.3.</span> <span class="nav-text">流量控制（流控，flow control）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#概述-3"><span class="nav-number">13.3.1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#流控模式"><span class="nav-number">13.3.2.</span> <span class="nav-text">流控模式</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#设置"><span class="nav-number">13.3.2.1.</span> <span class="nav-text">设置</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#熔断降级"><span class="nav-number">13.4.</span> <span class="nav-text">熔断降级</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#概述-4"><span class="nav-number">13.4.1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#策略"><span class="nav-number">13.4.2.</span> <span class="nav-text">策略</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#热点key"><span class="nav-number">13.5.</span> <span class="nav-text">热点key</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#概述-5"><span class="nav-number">13.5.1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#简单使用"><span class="nav-number">13.5.2.</span> <span class="nav-text">简单使用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#参数例外项"><span class="nav-number">13.5.3.</span> <span class="nav-text">参数例外项</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#系统规则（系统自适应限流）"><span class="nav-number">13.6.</span> <span class="nav-text">系统规则（系统自适应限流）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SentinelResource"><span class="nav-number">13.7.</span> <span class="nav-text">@SentinelResource</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#概述-6"><span class="nav-number">13.7.1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#参数说明"><span class="nav-number">13.7.2.</span> <span class="nav-text">参数说明</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#自定义限流处理"><span class="nav-number">13.7.3.</span> <span class="nav-text">自定义限流处理</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Feign"><span class="nav-number">13.7.3.1.</span> <span class="nav-text">Feign</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#持久化"><span class="nav-number">13.7.4.</span> <span class="nav-text">持久化</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#持久化到-Nacos"><span class="nav-number">13.7.4.1.</span> <span class="nav-text">持久化到 Nacos</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Seata"><span class="nav-number">14.</span> <span class="nav-text">Seata</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#分布式事务"><span class="nav-number">14.1.</span> <span class="nav-text">分布式事务</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#概述-7"><span class="nav-number">14.1.1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#分布式事务过程（一ID-三组件）"><span class="nav-number">14.1.2.</span> <span class="nav-text">分布式事务过程（一ID + 三组件）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Seata-1"><span class="nav-number">14.2.</span> <span class="nav-text">Seata</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#概述-8"><span class="nav-number">14.2.1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#下载安装"><span class="nav-number">14.2.2.</span> <span class="nav-text">下载安装</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用-2"><span class="nav-number">14.3.</span> <span class="nav-text">使用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#配置-1"><span class="nav-number">14.3.1.</span> <span class="nav-text">配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#架构图"><span class="nav-number">14.3.2.</span> <span class="nav-text">架构图</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#步骤"><span class="nav-number">14.3.3.</span> <span class="nav-text">步骤</span></a></li></ol></li></ol></li></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2020</span> <span class="with-love"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">PhoenixBM</span></div><div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div><span class="post-meta-divider">|</span><div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div><div class="busuanzi-count"><script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="//cdn.jsdelivr.net/jquery/2.1.3/jquery.min.js"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/lib/three/three.min.js"></script><script type="text/javascript" src="/lib/three/three-waves.min.js"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script type="text/javascript">var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: true,
        appId: 'Wpo80uJal0GctCdCEWeay3GX-MdYXbMMI',
        appKey: 'aSgohaGfCfEtTVX44x7Av9Et',
        placeholder: 'Just go go',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });</script><script type="text/javascript">function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css("overflow","hidden"),$(".search-popup-overlay").click(onPopupClose),$(".popup").toggle();var t=$("#local-search-input");t.attr("autocapitalize","none"),t.attr("autocorrect","off"),t.focus()}var isfetched=!1,isXml=!0,search_path="search.xml";0===search_path.length?search_path="search.xml":/json$/i.test(search_path)&&(isXml=!1);var path="/"+search_path,onPopupClose=function(t){$(".popup").hide(),$("#local-search-input").val(""),$(".search-result-list").remove(),$("#no-result").remove(),$(".local-search-pop-overlay").remove(),$("body").css("overflow","")},searchFunc=function(t,e,o){"use strict";$("body").append('<div class="search-popup-overlay local-search-pop-overlay"><div id="search-loading-icon"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div>').css("overflow","hidden"),$("#search-loading-icon").css("margin","20% auto 0 auto").css("text-align","center"),$.ajax({url:t,dataType:isXml?"xml":"json",async:!0,success:function(t){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var n=isXml?$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():t,r=document.getElementById(e),s=document.getElementById(o),a=function(){var t=r.value.trim().toLowerCase(),e=t.split(/[\s\-]+/);e.length>1&&e.push(t);var o=[];if(t.length>0&&n.forEach(function(n){function r(e,o,n,r){for(var s=r[r.length-1],a=s.position,i=s.word,l=[],h=0;a+i.length<=n&&0!=r.length;){i===t&&h++,l.push({position:a,length:i.length});var p=a+i.length;for(r.pop();0!=r.length&&(s=r[r.length-1],a=s.position,i=s.word,p>a);)r.pop()}return c+=h,{hits:l,start:o,end:n,searchTextCount:h}}function s(t,e){var o="",n=e.start;return e.hits.forEach(function(e){o+=t.substring(n,e.position);var r=e.position+e.length;o+='<b class="search-keyword">'+t.substring(e.position,r)+"</b>",n=r}),o+=t.substring(n,e.end)}var a=!1,i=0,c=0,l=n.title.trim(),h=l.toLowerCase(),p=n.content.trim().replace(/<[^>]+>/g,""),u=p.toLowerCase(),f=decodeURIComponent(n.url),d=[],g=[];if(""!=l&&(e.forEach(function(t){function e(t,e,o){var n=t.length;if(0===n)return[];var r=0,s=[],a=[];for(o||(e=e.toLowerCase(),t=t.toLowerCase());(s=e.indexOf(t,r))>-1;)a.push({position:s,word:t}),r=s+n;return a}d=d.concat(e(t,h,!1)),g=g.concat(e(t,u,!1))}),(d.length>0||g.length>0)&&(a=!0,i=d.length+g.length)),a){[d,g].forEach(function(t){t.sort(function(t,e){return e.position!==t.position?e.position-t.position:t.word.length-e.word.length})});var v=[];0!=d.length&&v.push(r(l,0,l.length,d));for(var $=[];0!=g.length;){var C=g[g.length-1],m=C.position,x=C.word,w=m-20,y=m+80;w<0&&(w=0),y<m+x.length&&(y=m+x.length),y>p.length&&(y=p.length),$.push(r(p,w,y,g))}$.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hits.length!==e.hits.length?e.hits.length-t.hits.length:t.start-e.start});var T=parseInt("1");T>=0&&($=$.slice(0,T));var b="";b+=0!=v.length?"<li><a href='"+f+"' class='search-result-title'>"+s(l,v[0])+"</a>":"<li><a href='"+f+"' class='search-result-title'>"+l+"</a>",$.forEach(function(t){b+="<a href='"+f+'\'><p class="search-result">'+s(p,t)+"...</p></a>"}),b+="</li>",o.push({item:b,searchTextCount:c,hitCount:i,id:o.length})}}),1===e.length&&""===e[0])s.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x" /></div>';else if(0===o.length)s.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>';else{o.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hitCount!==e.hitCount?e.hitCount-t.hitCount:e.id-t.id});var a='<ul class="search-result-list">';o.forEach(function(t){a+=t.item}),a+="</ul>",s.innerHTML=a}};r.addEventListener("input",a),$(".local-search-pop-overlay").remove(),$("body").css("overflow",""),proceedsearch()}})};$(".popup-trigger").click(function(t){t.stopPropagation(),isfetched===!1?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(onPopupClose),$(".popup").click(function(t){t.stopPropagation()}),$(document).on("keyup",function(t){var e=27===t.which&&$(".search-popup").is(":visible");e&&onPopupClose()})</script><script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script><script>AV.initialize("Wpo80uJal0GctCdCEWeay3GX-MdYXbMMI","aSgohaGfCfEtTVX44x7Av9Et")</script><script>function showTime(e){var t=new AV.Query(e),n=[],o=$(".leancloud_visitors");o.each(function(){n.push($(this).attr("id").trim())}),t.containedIn("url",n),t.find().done(function(e){var t=".leancloud-visitors-count";if(0===e.length)return void o.find(t).text(0);for(var i=0;i<e.length;i++){var r=e[i],s=r.get("url"),l=r.get("time"),c=document.getElementById(s);$(c).find(t).text(l)}for(var i=0;i<n.length;i++){var s=n[i],c=document.getElementById(s),u=$(c).find(t);""==u.text()&&u.text(0)}}).fail(function(e,t){console.log("Error: "+t.code+" "+t.message)})}function addCount(e){var t=$(".leancloud_visitors"),n=t.attr("id").trim(),o=t.attr("data-flag-title").trim(),i=new AV.Query(e);i.equalTo("url",n),i.find({success:function(t){if(t.length>0){var i=t[0];i.fetchWhenSave(!0),i.increment("time"),i.save(null,{success:function(e){var t=$(document.getElementById(n));t.find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to save Visitor num, with error message: "+t.message)}})}else{var r=new e,s=new AV.ACL;s.setPublicReadAccess(!0),s.setPublicWriteAccess(!0),r.setACL(s),r.set("title",o),r.set("url",n),r.set("time",1),r.save(null,{success:function(e){var t=$(document.getElementById(n));t.find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to create")}})}},error:function(e){console.log("Error:"+e.code+" "+e.message)}})}$(function(){var e=AV.Object.extend("Counter");1==$(".leancloud_visitors").length?addCount(e):$(".post-title-link").length>1&&showTime(e)})</script><script async src="/js/cursor/fireworks.js"></script><script type="text/javascript" src="/js/src/clipboard.min.js"></script><script type="text/javascript" src="/js/src/clipboard-use.js"></script></body></html><!-- rebuild by neat -->